import{$,e as V,M as ye,w as Q}from"./wallet._BUyEF6v.js";function R(e){return Ce.test(e)}var Ce=/^-?[0-9]+$/;function $e(e){return Te.test(e)}var Te=/^-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?$/;function Ne(e,t){var n=parseFloat(e),r=String(n),o=J(e),s=J(r);if(o===s)return!0;if(t?.approx===!0){var u=14;if(!R(e)&&s.length>=u&&o.startsWith(s.substring(0,u)))return!0}return!1}var g=function(e){return e.underflow="underflow",e.overflow="overflow",e.truncate_integer="truncate_integer",e.truncate_float="truncate_float",e}({});function ge(e){if(!Ne(e,{approx:!1})){if(R(e))return g.truncate_integer;var t=parseFloat(e);return isFinite(t)?t===0?g.underflow:g.truncate_float:g.overflow}}function J(e){return e.replace(Ie,"").replace(ke,"").replace(Oe,"").replace(Ae,"")}var Ie=/[eE][+-]?\d+$/,Ae=/^-?(0*)?/,ke=/\./,Oe=/0+$/;function T(e){"@babel/helpers - typeof";return T=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},T(e)}function De(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Re(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,te(r.key),r)}}function Le(e,t,n){return t&&Re(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function _e(e,t,n){return t=te(t),t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function te(e){var t=Pe(e,"string");return T(t)==="symbol"?t:String(t)}function Pe(e,t){if(T(e)!=="object"||e===null)return e;var n=e[Symbol.toPrimitive];if(n!==void 0){var r=n.call(e,t||"default");if(T(r)!=="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}var xe=function(){function e(t){if(De(this,e),_e(this,"isLosslessNumber",!0),!$e(t))throw new Error('Invalid number (value: "'+t+'")');this.value=t}return Le(e,[{key:"valueOf",value:function(){var n=ge(this.value);if(n===void 0||n===g.truncate_float)return parseFloat(this.value);if(R(this.value))return BigInt(this.value);throw new Error("Cannot safely convert to number: "+"the value '".concat(this.value,"' would ").concat(n," and become ").concat(parseFloat(this.value)))}},{key:"toString",value:function(){return this.value}}]),e}();function Me(e){return e&&T(e)==="object"&&e.isLosslessNumber===!0||!1}function qe(e){return new xe(e)}function Ge(e){return R(e)?BigInt(e):parseFloat(e)}function M(e){"@babel/helpers - typeof";return M=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},M(e)}function Fe(e,t){return K({"":e},"",e,t)}function K(e,t,n,r){return Array.isArray(n)?r.call(e,t,Ue(n,r)):n&&M(n)==="object"&&!Me(n)?r.call(e,t,Be(n,r)):r.call(e,t,n)}function Be(e,t){return Object.keys(e).forEach(function(n){var r=K(e,n,e[n],t);r!==void 0?e[n]=r:delete e[n]}),e}function Ue(e,t){for(var n=0;n<e.length;n++)e[n]=K(e,n+"",e[n],t);return e}function q(e){"@babel/helpers - typeof";return q=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},q(e)}function P(e){return Xe(e)||We(e)||Ke(e)||Ve()}function Ve(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Ke(e,t){if(e){if(typeof e=="string")return G(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor&&(n=e.constructor.name),n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return G(e,t)}}function We(e){if(typeof Symbol<"u"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function Xe(e){if(Array.isArray(e))return G(e)}function G(e,t){(t==null||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function je(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:qe,r=0,o=d();return ce(o),he(),t?Fe(o,t):o;function s(){if(e.charCodeAt(r)===Ye){r++,l();for(var i={},c=!0;r<e.length&&e.charCodeAt(r)!==z;){c?c=!1:(H(),l());var p=r,w=j();w===void 0&&fe(),l(),se();var S=d();S===void 0&&be(),Object.prototype.hasOwnProperty.call(i,w)&&!F(S,i[w])&&le(w,p+1),i[w]=S}return e.charCodeAt(r)!==z&&de(),r++,i}}function u(){if(e.charCodeAt(r)===et){r++,l();for(var i=[],c=!0;r<e.length&&e.charCodeAt(r)!==Y;){c?c=!1:H();var p=d();ae(p),i.push(p)}return e.charCodeAt(r)!==Y&&pe(),r++,i}}function d(){var i,c,p,w,S,_;l();var Se=(i=(c=(p=(w=(S=(_=j())!==null&&_!==void 0?_:oe())!==null&&S!==void 0?S:s())!==null&&w!==void 0?w:u())!==null&&p!==void 0?p:f("true",!0))!==null&&c!==void 0?c:f("false",!1))!==null&&i!==void 0?i:f("null",null);return l(),Se}function f(i,c){if(e.slice(r,r+i.length)===i)return r+=i.length,c}function l(){for(;He(e.charCodeAt(r));)r++}function j(){if(e.charCodeAt(r)===x){r++;for(var i="";r<e.length&&e.charCodeAt(r)!==x;){if(e.charCodeAt(r)===ze){var c=e[r+1],p=Ze[c];p!==void 0?(i+=p,r++):c==="u"?A(e.charCodeAt(r+2))&&A(e.charCodeAt(r+3))&&A(e.charCodeAt(r+4))&&A(e.charCodeAt(r+5))?(i+=String.fromCharCode(parseInt(e.slice(r+2,r+6),16)),r+=5):we(r):me(r)}else Je(e.charCodeAt(r))?i+=e[r]:ve(e[r]);r++}return ue(),r++,i}}function oe(){var i=r;if(e.charCodeAt(r)===ee&&(r++,L(i)),e.charCodeAt(r)===W)r++;else if(Qe(e.charCodeAt(r)))for(r++;k(e.charCodeAt(r));)r++;if(e.charCodeAt(r)===at)for(r++,L(i);k(e.charCodeAt(r));)r++;if(e.charCodeAt(r)===dt||e.charCodeAt(r)===lt)for(r++,(e.charCodeAt(r)===ee||e.charCodeAt(r)===ot)&&r++,L(i);k(e.charCodeAt(r));)r++;if(r>i)return n(e.slice(i,r))}function H(){if(e.charCodeAt(r)!==ct)throw new SyntaxError("Comma ',' expected after value ".concat(b()));r++}function se(){if(e.charCodeAt(r)!==ht)throw new SyntaxError("Colon ':' expected after property name ".concat(b()));r++}function ce(i){if(i===void 0)throw new SyntaxError("JSON value expected ".concat(b()))}function ae(i){if(i===void 0)throw new SyntaxError("Array item expected ".concat(b()))}function he(){if(r<e.length)throw new SyntaxError("Expected end of input ".concat(b()))}function L(i){if(!k(e.charCodeAt(r))){var c=e.slice(i,r);throw new SyntaxError("Invalid number '".concat(c,"', expecting a digit ").concat(b()))}}function ue(){if(e.charCodeAt(r)!==x)throw new SyntaxError(`End of string '"' expected `.concat(b()))}function fe(){throw new SyntaxError("Quoted object key expected ".concat(b()))}function le(i,c){throw new SyntaxError("Duplicate key '".concat(i,"' encountered at position ").concat(c))}function de(){throw new SyntaxError("Quoted object key or end of object '}' expected ".concat(b()))}function pe(){throw new SyntaxError("Array item or end of array ']' expected ".concat(b()))}function ve(i){throw new SyntaxError("Invalid character '".concat(i,"' ").concat(N()))}function me(i){var c=e.slice(i,i+2);throw new SyntaxError("Invalid escape character '".concat(c,"' ").concat(N()))}function be(){throw new SyntaxError("Object value expected after ':' ".concat(N()))}function we(i){for(var c=i+2;/\w/.test(e[c]);)c++;var p=e.slice(i,c);throw new SyntaxError("Invalid unicode character '".concat(p,"' ").concat(N()))}function N(){return"at position ".concat(r)}function Ee(){return r<e.length?"but got '".concat(e[r],"'"):"but reached end of input"}function b(){return Ee()+" "+N()}}function He(e){return e===tt||e===rt||e===nt||e===it}function A(e){return e>=W&&e<=X||e>=ut&&e<=pt||e>=ft&&e<=vt}function k(e){return e>=W&&e<=X}function Qe(e){return e>=st&&e<=X}function Je(e){return e>=32&&e<=1114111}function F(e,t){if(e===t)return!0;if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every(function(r,o){return F(r,t[o])});if(Z(e)&&Z(t)){var n=P(new Set([].concat(P(Object.keys(e)),P(Object.keys(t)))));return n.every(function(r){return F(e[r],t[r])})}return!1}function Z(e){return q(e)==="object"&&e!==null}var Ze={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:`
`,r:"\r",t:"	"},ze=92,Ye=123,z=125,et=91,Y=93,tt=32,rt=10,nt=9,it=13,x=34,ot=43,ee=45,W=48,st=49,X=57,ct=44,at=46,ht=58,ut=65,ft=97,lt=69,dt=101,pt=70,vt=102;function E(e,t,n,r){Object.defineProperty(e,t,{get:n,set:r,enumerable:!0,configurable:!0})}const C={client:$("electrum-cash:client "),cluster:$("electrum-cash:cluster"),errors:$("electrum-cash:error  "),warning:$("electrum-cash:warning"),network:$("electrum-cash:network"),ping:$("electrum-cash:pulses ")};C.client.color="2";C.cluster.color="3";C.errors.color="9";C.warning.color="13";C.network.color="4";C.ping.color="8";var a=C;class mt{static buildRequestObject(t,n,r){return JSON.stringify({method:t,params:n,id:r})}static get versionRegexp(){return/^\d+(\.\d+)+$/}static get statementDelimiter(){return`
`}}var y=mt,re={};E(re,"isVersionRejected",()=>ne);E(re,"isVersionNegotiated",()=>bt);const ne=function(e){return"error"in e},bt=function(e){return"software"in e&&"protocol"in e};var ie={};E(ie,"ElectrumTransport",()=>v);E(ie,"DefaultParameters",()=>m);var I={};E(I,"ClusterOrder",()=>O);E(I,"ClusterDistribution",()=>D);E(I,"ClusterStatus",()=>B);E(I,"ClientState",()=>U);E(I,"ConnectionStatus",()=>h);var O;(function(e){e[e.RANDOM=0]="RANDOM",e[e.PRIORITY=1]="PRIORITY"})(O||(O={}));var D;(function(e){e[e.ALL=0]="ALL"})(D||(D={}));var B;(function(e){e[e.DISABLED=0]="DISABLED",e[e.DEGRADED=1]="DEGRADED",e[e.READY=2]="READY"})(B||(B={}));var U;(function(e){e[e.UNAVAILABLE=0]="UNAVAILABLE",e[e.AVAILABLE=1]="AVAILABLE"})(U||(U={}));var h;(function(e){e[e.DISCONNECTED=0]="DISCONNECTED",e[e.CONNECTED=1]="CONNECTED",e[e.DISCONNECTING=2]="DISCONNECTING",e[e.CONNECTING=3]="CONNECTING",e[e.RECONNECTING=4]="RECONNECTING"})(h||(h={}));const v={TCP:{Port:50001,Scheme:"tcp"},TCP_TLS:{Port:50002,Scheme:"tcp_tls"},WS:{Port:50003,Scheme:"ws"},WSS:{Port:50004,Scheme:"wss"}},m={PORT:v.TCP_TLS.Port,TRANSPORT_SCHEME:v.TCP_TLS.Scheme,RECONNECT:5e3,TIMEOUT:3e4,PING_INTERVAL:1e3,CLUSTER_CONFIDENCE:1,CLUSTER_DISTRIBUTION:D.ALL,CLUSTER_ORDER:O.RANDOM,USE_BIG_INT:!1};class wt extends V.EventEmitter{connect(t,n,r,o){if(this.tcpSocket||this.webSocket)throw new Error("Cannot initiate a new socket connection when an existing connection exists");this.timers.disconnect=setTimeout(()=>this.disconnectOnTimeout(t,n,o),o),this.once("connect",this.clearDisconnectTimerOnTimeout);const s={[v.TCP.Scheme]:"a TCP Socket",[v.TCP_TLS.Scheme]:"an encrypted TCP socket",[v.WS.Scheme]:"a WebSocket",[v.WSS.Scheme]:"an encrypted WebSocket"};if(a.network(`Initiating ${s[r]} connection to '${t}:${n}'.`),r===v.TCP.Scheme||r===v.TCP_TLS.Scheme){if(r===v.TCP_TLS.Scheme){const u={rejectUnauthorized:!1};$4QiMX$isIP(t)||(u.serverName=t),this.tcpSocket=$4QiMX$connect(n,t,u),this.tcpSocket.once("secureConnect",()=>{if(!(this.tcpSocket instanceof $4QiMX$TLSSocket))return;this.tcpSocket.authorizationError==="DEPTH_ZERO_SELF_SIGNED_CERT"&&a.warning(`Connection to ${t}:${n} uses a self-signed certificate`)}),this.tcpSocket.on("secureConnect",this.onConnect.bind(this,s[r],t,n))}else this.tcpSocket=$4QiMX$connect1({host:t,port:n}),this.tcpSocket.on("connect",this.onConnect.bind(this,s[r],t,n));this.tcpSocket.setEncoding("utf8"),this.tcpSocket.setKeepAlive(!0,0),this.tcpSocket.setNoDelay(!0),this.tcpSocket.on("error",this.eventForwarders.tcpError)}else if(r===v.WS.Scheme||r===v.WSS.Scheme)r===v.WSS.Scheme?this.webSocket=new Q(`wss://${t}:${n}`):this.webSocket=new Q(`ws://${t}:${n}`),this.webSocket.addEventListener("open",this.onConnect.bind(this,s[r],t,n)),this.webSocket.addEventListener("error",this.eventForwarders.wsError);else throw new Error("Incorrect transport specified")}onConnect(t,n,r){this.onConnectHasRun||(a.network(`Established ${t} connection with '${n}:${r}'.`),typeof this.tcpSocket<"u"?(this.tcpSocket.addListener("close",this.eventForwarders.disconnect),this.tcpSocket.addListener("data",this.eventForwarders.tcpData)):typeof this.webSocket<"u"&&(this.webSocket.addEventListener("close",this.eventForwarders.disconnect),this.webSocket.addEventListener("message",this.eventForwarders.wsData)),this.onConnectHasRun=!0,this.emit("connect"))}clearDisconnectTimerOnTimeout(){this.timers.disconnect&&clearTimeout(this.timers.disconnect)}disconnect(){if(this.clearDisconnectTimerOnTimeout(),this.tcpSocket)this.tcpSocket.removeListener("close",this.eventForwarders.disconnect),this.tcpSocket.removeListener("data",this.eventForwarders.tcpData),this.tcpSocket.removeListener("error",this.eventForwarders.tcpError),this.tcpSocket.destroy(),this.tcpSocket=void 0;else if(this.webSocket)try{this.webSocket.removeEventListener("close",this.eventForwarders.disconnect),this.webSocket.removeEventListener("message",this.eventForwarders.wsData),this.webSocket.removeEventListener("error",this.eventForwarders.wsError),this.webSocket.close()}catch{}finally{this.webSocket=void 0}this.onConnectHasRun=!1,this.emit("disconnect")}write(t,n){if(this.tcpSocket)return this.tcpSocket.write(t,n);if(this.webSocket)return this.webSocket.send(t,n),!0;throw new Error("Cannot write to socket when there is no active connection")}disconnectOnTimeout(t,n,r){this.removeListener("connect",this.clearDisconnectTimerOnTimeout);const o={code:"ETIMEDOUT",message:`Connection to '${t}:${n}' timed out after ${r} milliseconds`};this.emit("error",o),this.disconnect()}constructor(...t){super(...t),this.timers={},this.onConnectHasRun=!1,this.eventForwarders={disconnect:()=>this.emit("disconnect"),tcpData:n=>this.emit("data",n),wsData:n=>this.emit("data",`${n.data}
`),tcpError:n=>this.emit("error",n),wsError:n=>this.emit("error",n.error)}}}var Et=wt;class St extends V.EventEmitter{constructor(t,n,r,o=m.PORT,s=m.TRANSPORT_SCHEME,u=m.TIMEOUT,d=m.PING_INTERVAL,f=m.RECONNECT,l=m.USE_BIG_INT){if(super(),this.application=t,this.version=n,this.host=r,this.port=o,this.scheme=s,this.timeout=u,this.pingInterval=d,this.reconnectInterval=f,this.useBigInt=l,this.timers={},this.verifications=[],this.status=h.DISCONNECTED,this.messageBuffer="",!y.versionRegexp.test(n))throw new Error(`Provided version string (${n}) is not a valid protocol version number.`);this.createSocket(),typeof document<"u"&&document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this))}get hostIdentifier(){return`${this.host}:${this.port}`}createSocket(){this.socket=new Et,this.socket.on("connect",this.onSocketConnect.bind(this)),this.socket.on("disconnect",this.onSocketDisconnect.bind(this)),this.socket.on("data",this.parseMessageChunk.bind(this))}destroySocket(){this.socket.disconnect()}parseMessageChunk(t){for(this.lastReceivedTimestamp=Date.now(),this.verifications.forEach(n=>clearTimeout(n)),this.verifications.length=0,this.messageBuffer+=t;this.messageBuffer.includes(y.statementDelimiter);){const n=this.messageBuffer.split(y.statementDelimiter);for(;n.length>1;){const r=String(n.shift());let o=je(r,null,this.useBigInt?Ge:parseFloat);for(Array.isArray(o)||(o=[o]);o.length>0;){const s=o.shift();if(s.id==="versionNegotiation"){s.error?this.emit("version",{error:s.error}):this.emit("version",{software:s.result[0],protocol:s.result[1]});continue}s.id!=="keepAlive"&&this.emit("statement",s)}}this.messageBuffer=n.shift()||""}}ping(){a.ping(`Sending keep-alive ping to '${this.hostIdentifier}'`);const t=y.buildRequestObject("server.ping",[],"keepAlive");return this.send(t)}async connect(){if(this.status===h.CONNECTED)return;this.status=h.CONNECTING;const t=(n,r)=>{const o=u=>{this.status=h.DISCONNECTED,r(u)};this.socket.removeAllListeners("error"),this.socket.once("error",o);const s=()=>{a.network(`Requesting protocol version ${this.version} with '${this.hostIdentifier}'.`),this.socket.removeListener("error",o);const u=y.buildRequestObject("server.version",[this.application,this.version],"versionNegotiation"),d=f=>{if(ne(f)){this.disconnect(!0);const l="unsupported protocol version.";a.errors(`Failed to connect with ${this.hostIdentifier} due to ${l}`),r(l)}else if(f.protocol!==this.version&&`${f.protocol}.0`!==this.version&&`${f.protocol}.0.0`!==this.version){this.disconnect(!0);const l=`incompatible protocol version negotiated (${f.protocol} !== ${this.version}).`;a.errors(`Failed to connect with ${this.hostIdentifier} due to ${l}`),r(l)}else a.network(`Negotiated protocol version ${f.protocol} with '${this.hostIdentifier}', powered by ${f.software}.`),this.status=h.CONNECTED,this.emit("connect"),n()};this.once("version",d),this.send(u)};this.socket.once("connect",s),this.socket.on("error",this.onSocketError.bind(this)),this.socket.connect(this.host,this.port,this.scheme,this.timeout)};await new Promise(t)}async reconnect(){await this.clearReconnectTimer(),a.network(`Trying to reconnect to '${this.hostIdentifier}'..`),this.status=h.RECONNECTING,this.destroySocket(),this.createSocket();try{await this.connect()}catch{}}clearReconnectTimer(){this.timers.reconnect&&clearTimeout(this.timers.reconnect),this.timers.reconnect=void 0}clearKeepAliveTimer(){this.timers.keepAlive&&clearTimeout(this.timers.keepAlive),this.timers.keepAlive=void 0}setupKeepAliveTimer(){this.timers.keepAlive||(this.timers.keepAlive=setTimeout(this.ping.bind(this),this.pingInterval))}async disconnect(t=!1,n=!0){if(this.status===h.DISCONNECTED&&!t)return!1;n&&(this.status=h.DISCONNECTING),await this.clearKeepAliveTimer(),await this.clearReconnectTimer();const r=o=>{this.once("disconnect",()=>o(!0)),this.destroySocket()};return new Promise(r)}async handleVisibilityChange(){document.visibilityState==="hidden"&&this.disconnect(!0,!1),document.visibilityState==="visible"&&this.reconnect()}send(t){this.clearKeepAliveTimer();const n=Date.now(),r=setTimeout(this.verifySend.bind(this,n),this.timeout);return this.verifications.push(r),this.setupKeepAliveTimer(),this.socket.write(t+y.statementDelimiter)}verifySend(t){if(Number(this.lastReceivedTimestamp)<t){if(this.status===h.DISCONNECTED||this.status===h.DISCONNECTING){a.errors(`Tried to verify already disconnected connection to '${this.hostIdentifier}'`);return}this.clearKeepAliveTimer(),a.network(`Connection to '${this.hostIdentifier}' timed out.`),this.socket.disconnect()}}onSocketConnect(){this.clearReconnectTimer(),this.lastReceivedTimestamp=Date.now(),this.setupKeepAliveTimer(),this.socket.removeAllListeners("error"),this.socket.on("error",this.onSocketError.bind(this))}onSocketDisconnect(){this.emit("disconnect"),this.clearKeepAliveTimer(),this.status===h.DISCONNECTING?(this.clearReconnectTimer(),this.removeAllListeners(),this.status=h.DISCONNECTED,a.network(`Disconnected from '${this.hostIdentifier}'.`)):(this.status===h.CONNECTED&&a.errors(`Connection with '${this.hostIdentifier}' was closed, trying to reconnect in ${this.reconnectInterval/1e3} seconds.`),this.status=h.DISCONNECTED,this.timers.reconnect||(this.timers.reconnect=setTimeout(this.reconnect.bind(this),this.reconnectInterval)))}onSocketError(t){if(!(typeof t>"u")){if(t.code==="EAI_AGAIN"){a.errors(`Failed to look up DNS records for '${this.host}'.`);return}if(t.code==="ETIMEDOUT"){a.errors(t.message);return}a.errors(`Unknown network error ('${this.hostIdentifier}'): `,t)}}}var yt=St;const Ct=function(e){return"id"in e&&"error"in e},$t=function(e){return!("id"in e)&&"method"in e};class Tt extends V.EventEmitter{constructor(t,n,r,o=m.PORT,s=m.TRANSPORT_SCHEME,u=m.TIMEOUT,d=m.PING_INTERVAL,f=m.RECONNECT,l=m.USE_BIG_INT){super(),this.subscriptionMethods={},this.requestId=0,this.requestResolvers={},this.connectionLock=new ye,this.connection=new yt(t,n,r,o,s,u,d,f,l)}async connect(){const t=await this.connectionLock.acquire();try{if(this.connection.status===h.CONNECTED)return;this.connection.on("statement",this.response.bind(this)),this.connection.on("connect",this.resubscribeOnConnect.bind(this)),this.connection.on("connect",this.emit.bind(this,"connected")),this.connection.on("disconnect",this.onConnectionDisconnect.bind(this)),this.connection.on("error",this.emit.bind(this,"error")),await this.connection.connect()}finally{t()}}async disconnect(t=!1,n=!1){const r=await this.connectionLock.acquire();try{n||(this.removeAllListeners(),this.subscriptionMethods={});for(const o in this.requestResolvers){const s=this.requestResolvers[o];s(new Error("Manual disconnection")),delete this.requestResolvers[o]}return await this.connection.disconnect(t)}finally{r()}}async request(t,...n){if(this.connection.status!==h.CONNECTED)throw new Error(`Unable to send request to a disconnected server '${this.connection.host}'.`);this.requestId+=1;const r=this.requestId,o=y.buildRequestObject(t,n,r),s=u=>{this.requestResolvers[r]=(d,f)=>{u(d||f)},this.connection.send(o)};return a.network(`Sending request '${t}' to '${this.connection.host}'`),new Promise(s)}async subscribe(t,...n){this.subscriptionMethods[t]||(this.subscriptionMethods[t]=new Set),this.subscriptionMethods[t].add(JSON.stringify(n));const r=await this.request(t,...n),o={jsonrpc:"2.0",method:t,params:[...n,r]};this.emit("notification",o)}async unsubscribe(t,...n){if(this.connection.status!==h.CONNECTED)throw new Error(`Unable to send unsubscribe request to a disconnected server '${this.connection.host}'.`);if(!this.subscriptionMethods[t])throw new Error(`Cannot unsubscribe from '${t}' since the method has no subscriptions.`);const r=JSON.stringify(n);if(!this.subscriptionMethods[t].has(r))throw new Error(`Cannot unsubscribe from '${t}' since it has no subscription with the given parameters.`);this.subscriptionMethods[t].delete(r),await this.request(t.replace(".subscribe",".unsubscribe"),...n),a.client(`Unsubscribed from '${String(t)}' for the '${r}' parameters.`)}async resubscribeOnConnect(){a.client(`Connected to '${this.connection.hostIdentifier}'.`);const t=[];for(const n in this.subscriptionMethods){for(const r of this.subscriptionMethods[n].values()){const o=JSON.parse(r);t.push(this.subscribe(n,...o))}await Promise.all(t)}t.length>0&&a.client(`Restored ${t.length} previous subscriptions for '${this.connection.hostIdentifier}'`)}response(t){if($t(t)){a.client(`Received notification for '${t.method}' from '${this.connection.host}'`),this.emit("notification",t);return}if(t.id===null)throw new Error("Internal error: Received an RPC response with ID null.");const n=this.requestResolvers[t.id];if(!n)throw new Error("Internal error: Callback for response not available.");delete this.requestResolvers[t.id],Ct(t)?n(new Error(t.error.message)):n(void 0,t.result)}onConnectionDisconnect(){this.emit("disconnected");for(const t in this.requestResolvers){const n=this.requestResolvers[t];n(new Error("Connection lost")),delete this.requestResolvers[t]}}}var gt=Tt;export{gt as $,v as a};
//# sourceMappingURL=index.B52t-Qvl.js.map
