import{g as q,$ as k,e as X}from"./browser.CrXa5AcC.js";const $e=new Error("request for lock canceled");var Ce=function(e,t,n,r){function i(o){return o instanceof n?o:new n(function(c){c(o)})}return new(n||(n=Promise))(function(o,c){function p(d){try{a(r.next(d))}catch(E){c(E)}}function u(d){try{a(r.throw(d))}catch(E){c(E)}}function a(d){d.done?o(d.value):i(d.value).then(p,u)}a((r=r.apply(e,t||[])).next())})};class Te{constructor(t,n=$e){this._value=t,this._cancelError=n,this._weightedQueues=[],this._weightedWaiters=[]}acquire(t=1){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);return new Promise((n,r)=>{this._weightedQueues[t-1]||(this._weightedQueues[t-1]=[]),this._weightedQueues[t-1].push({resolve:n,reject:r}),this._dispatch()})}runExclusive(t,n=1){return Ce(this,void 0,void 0,function*(){const[r,i]=yield this.acquire(n);try{return yield t(r)}finally{i()}})}waitForUnlock(t=1){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);return new Promise(n=>{this._weightedWaiters[t-1]||(this._weightedWaiters[t-1]=[]),this._weightedWaiters[t-1].push(n),this._dispatch()})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(t){this._value=t,this._dispatch()}release(t=1){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);this._value+=t,this._dispatch()}cancel(){this._weightedQueues.forEach(t=>t.forEach(n=>n.reject(this._cancelError))),this._weightedQueues=[]}_dispatch(){var t;for(let n=this._value;n>0;n--){const r=(t=this._weightedQueues[n-1])===null||t===void 0?void 0:t.shift();if(!r)continue;const i=this._value,o=n;this._value-=n,n=this._value+1,r.resolve([i,this._newReleaser(o)])}this._drainUnlockWaiters()}_newReleaser(t){let n=!1;return()=>{n||(n=!0,this.release(t))}}_drainUnlockWaiters(){for(let t=this._value;t>0;t--)this._weightedWaiters[t-1]&&(this._weightedWaiters[t-1].forEach(n=>n()),this._weightedWaiters[t-1]=[])}}var Ne=function(e,t,n,r){function i(o){return o instanceof n?o:new n(function(c){c(o)})}return new(n||(n=Promise))(function(o,c){function p(d){try{a(r.next(d))}catch(E){c(E)}}function u(d){try{a(r.throw(d))}catch(E){c(E)}}function a(d){d.done?o(d.value):i(d.value).then(p,u)}a((r=r.apply(e,t||[])).next())})};class ke{constructor(t){this._semaphore=new Te(1,t)}acquire(){return Ne(this,void 0,void 0,function*(){const[,t]=yield this._semaphore.acquire();return t})}runExclusive(t){return this._semaphore.runExclusive(()=>t())}isLocked(){return this._semaphore.isLocked()}waitForUnlock(){return this._semaphore.waitForUnlock()}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}function x(e){return ge.test(e)}var ge=/^-?[0-9]+$/;function Ae(e){return Ie.test(e)}var Ie=/^-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?$/;function _e(e,t){var n=parseFloat(e),r=String(n),i=Z(e),o=Z(r);if(i===o)return!0;if(t?.approx===!0){var c=14;if(!x(e)&&o.length>=c&&i.startsWith(o.substring(0,c)))return!0}return!1}var I=function(e){return e.underflow="underflow",e.overflow="overflow",e.truncate_integer="truncate_integer",e.truncate_float="truncate_float",e}({});function Oe(e){if(!_e(e,{approx:!1})){if(x(e))return I.truncate_integer;var t=parseFloat(e);return isFinite(t)?t===0?I.underflow:I.truncate_float:I.overflow}}function Z(e){return e.replace(De,"").replace(Le,"").replace(xe,"").replace(Re,"")}var De=/[eE][+-]?\d+$/,Re=/^-?(0*)?/,Le=/\./,xe=/0+$/;function g(e){"@babel/helpers - typeof";return g=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},g(e)}function Pe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Me(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,ne(r.key),r)}}function qe(e,t,n){return t&&Me(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function We(e,t,n){return t=ne(t),t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ne(e){var t=Fe(e,"string");return g(t)==="symbol"?t:String(t)}function Fe(e,t){if(g(e)!=="object"||e===null)return e;var n=e[Symbol.toPrimitive];if(n!==void 0){var r=n.call(e,t||"default");if(g(r)!=="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}var Ge=function(){function e(t){if(Pe(this,e),We(this,"isLosslessNumber",!0),!Ae(t))throw new Error('Invalid number (value: "'+t+'")');this.value=t}return qe(e,[{key:"valueOf",value:function(){var n=Oe(this.value);if(n===void 0||n===I.truncate_float)return parseFloat(this.value);if(x(this.value))return BigInt(this.value);throw new Error("Cannot safely convert to number: "+"the value '".concat(this.value,"' would ").concat(n," and become ").concat(parseFloat(this.value)))}},{key:"toString",value:function(){return this.value}}]),e}();function Ue(e){return e&&g(e)==="object"&&e.isLosslessNumber===!0||!1}function Be(e){return new Ge(e)}function Ve(e){return x(e)?BigInt(e):parseFloat(e)}function G(e){"@babel/helpers - typeof";return G=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},G(e)}function Qe(e,t){return j({"":e},"",e,t)}function j(e,t,n,r){return Array.isArray(n)?r.call(e,t,Xe(n,r)):n&&G(n)==="object"&&!Ue(n)?r.call(e,t,Ke(n,r)):r.call(e,t,n)}function Ke(e,t){return Object.keys(e).forEach(function(n){var r=j(e,n,e[n],t);r!==void 0?e[n]=r:delete e[n]}),e}function Xe(e,t){for(var n=0;n<e.length;n++)e[n]=j(e,n+"",e[n],t);return e}function U(e){"@babel/helpers - typeof";return U=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},U(e)}function W(e){return Je(e)||ze(e)||He(e)||je()}function je(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function He(e,t){if(e){if(typeof e=="string")return B(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor&&(n=e.constructor.name),n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return B(e,t)}}function ze(e){if(typeof Symbol<"u"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function Je(e){if(Array.isArray(e))return B(e)}function B(e,t){(t==null||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Ze(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Be,r=0,i=p();return ae(i),ue(),t?Qe(i,t):i;function o(){if(e.charCodeAt(r)===it){r++,a();for(var s={},h=!0;r<e.length&&e.charCodeAt(r)!==ee;){h?h=!1:(J(),a());var v=r,S=d();S===void 0&&le(),a(),ce();var $=p();$===void 0&&be(),Object.prototype.hasOwnProperty.call(s,S)&&!V($,s[S])&&de(S,v+1),s[S]=$}return e.charCodeAt(r)!==ee&&pe(),r++,s}}function c(){if(e.charCodeAt(r)===ot){r++,a();for(var s=[],h=!0;r<e.length&&e.charCodeAt(r)!==te;){h?h=!1:J();var v=p();he(v),s.push(v)}return e.charCodeAt(r)!==te&&ve(),r++,s}}function p(){var s,h,v,S,$,M;a();var ye=(s=(h=(v=(S=($=(M=d())!==null&&M!==void 0?M:E())!==null&&$!==void 0?$:o())!==null&&S!==void 0?S:c())!==null&&v!==void 0?v:u("true",!0))!==null&&h!==void 0?h:u("false",!1))!==null&&s!==void 0?s:u("null",null);return a(),ye}function u(s,h){if(e.slice(r,r+s.length)===s)return r+=s.length,h}function a(){for(;Ye(e.charCodeAt(r));)r++}function d(){if(e.charCodeAt(r)===F){r++;for(var s="";r<e.length&&e.charCodeAt(r)!==F;){if(e.charCodeAt(r)===nt){var h=e[r+1],v=rt[h];v!==void 0?(s+=v,r++):h==="u"?O(e.charCodeAt(r+2))&&O(e.charCodeAt(r+3))&&O(e.charCodeAt(r+4))&&O(e.charCodeAt(r+5))?(s+=String.fromCharCode(parseInt(e.slice(r+2,r+6),16)),r+=5):Ee(r):me(r)}else tt(e.charCodeAt(r))?s+=e[r]:we(e[r]);r++}return fe(),r++,s}}function E(){var s=r;if(e.charCodeAt(r)===re&&(r++,P(s)),e.charCodeAt(r)===H)r++;else if(et(e.charCodeAt(r)))for(r++;D(e.charCodeAt(r));)r++;if(e.charCodeAt(r)===dt)for(r++,P(s);D(e.charCodeAt(r));)r++;if(e.charCodeAt(r)===bt||e.charCodeAt(r)===mt)for(r++,(e.charCodeAt(r)===re||e.charCodeAt(r)===ut)&&r++,P(s);D(e.charCodeAt(r));)r++;if(r>s)return n(e.slice(s,r))}function J(){if(e.charCodeAt(r)!==lt)throw new SyntaxError("Comma ',' expected after value ".concat(b()));r++}function ce(){if(e.charCodeAt(r)!==pt)throw new SyntaxError("Colon ':' expected after property name ".concat(b()));r++}function ae(s){if(s===void 0)throw new SyntaxError("JSON value expected ".concat(b()))}function he(s){if(s===void 0)throw new SyntaxError("Array item expected ".concat(b()))}function ue(){if(r<e.length)throw new SyntaxError("Expected end of input ".concat(b()))}function P(s){if(!D(e.charCodeAt(r))){var h=e.slice(s,r);throw new SyntaxError("Invalid number '".concat(h,"', expecting a digit ").concat(b()))}}function fe(){if(e.charCodeAt(r)!==F)throw new SyntaxError(`End of string '"' expected `.concat(b()))}function le(){throw new SyntaxError("Quoted object key expected ".concat(b()))}function de(s,h){throw new SyntaxError("Duplicate key '".concat(s,"' encountered at position ").concat(h))}function pe(){throw new SyntaxError("Quoted object key or end of object '}' expected ".concat(b()))}function ve(){throw new SyntaxError("Array item or end of array ']' expected ".concat(b()))}function we(s){throw new SyntaxError("Invalid character '".concat(s,"' ").concat(A()))}function me(s){var h=e.slice(s,s+2);throw new SyntaxError("Invalid escape character '".concat(h,"' ").concat(A()))}function be(){throw new SyntaxError("Object value expected after ':' ".concat(A()))}function Ee(s){for(var h=s+2;/\w/.test(e[h]);)h++;var v=e.slice(s,h);throw new SyntaxError("Invalid unicode character '".concat(v,"' ").concat(A()))}function A(){return"at position ".concat(r)}function Se(){return r<e.length?"but got '".concat(e[r],"'"):"but reached end of input"}function b(){return Se()+" "+A()}}function Ye(e){return e===st||e===ct||e===at||e===ht}function O(e){return e>=H&&e<=z||e>=vt&&e<=Et||e>=wt&&e<=St}function D(e){return e>=H&&e<=z}function et(e){return e>=ft&&e<=z}function tt(e){return e>=32&&e<=1114111}function V(e,t){if(e===t)return!0;if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every(function(r,i){return V(r,t[i])});if(Y(e)&&Y(t)){var n=W(new Set([].concat(W(Object.keys(e)),W(Object.keys(t)))));return n.every(function(r){return V(e[r],t[r])})}return!1}function Y(e){return U(e)==="object"&&e!==null}var rt={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:`
`,r:"\r",t:"	"},nt=92,it=123,ee=125,ot=91,te=93,st=32,ct=10,at=9,ht=13,F=34,ut=43,re=45,H=48,ft=49,z=57,lt=44,dt=46,pt=58,vt=65,wt=97,mt=69,bt=101,Et=70,St=102,T=null;typeof WebSocket<"u"?T=WebSocket:typeof MozWebSocket<"u"?T=MozWebSocket:typeof q<"u"?T=q.WebSocket||q.MozWebSocket:typeof window<"u"?T=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(T=self.WebSocket||self.MozWebSocket);function y(e,t,n,r){Object.defineProperty(e,t,{get:n,set:r,enumerable:!0,configurable:!0})}const N={client:k("electrum-cash:client "),cluster:k("electrum-cash:cluster"),errors:k("electrum-cash:error  "),warning:k("electrum-cash:warning"),network:k("electrum-cash:network"),ping:k("electrum-cash:pulses ")};N.client.color="2";N.cluster.color="3";N.errors.color="9";N.warning.color="13";N.network.color="4";N.ping.color="8";var f=N;class yt{static buildRequestObject(t,n,r){return JSON.stringify({method:t,params:n,id:r})}static get versionRegexp(){return/^\d+(\.\d+)+$/}static get statementDelimiter(){return`
`}}var C=yt,ie={};y(ie,"isVersionRejected",()=>oe);y(ie,"isVersionNegotiated",()=>$t);const oe=function(e){return"error"in e},$t=function(e){return"software"in e&&"protocol"in e};var se={};y(se,"ElectrumTransport",()=>w);y(se,"DefaultParameters",()=>m);var _={};y(_,"ClusterOrder",()=>R);y(_,"ClusterDistribution",()=>L);y(_,"ClusterStatus",()=>Q);y(_,"ClientState",()=>K);y(_,"ConnectionStatus",()=>l);var R;(function(e){e[e.RANDOM=0]="RANDOM",e[e.PRIORITY=1]="PRIORITY"})(R||(R={}));var L;(function(e){e[e.ALL=0]="ALL"})(L||(L={}));var Q;(function(e){e[e.DISABLED=0]="DISABLED",e[e.DEGRADED=1]="DEGRADED",e[e.READY=2]="READY"})(Q||(Q={}));var K;(function(e){e[e.UNAVAILABLE=0]="UNAVAILABLE",e[e.AVAILABLE=1]="AVAILABLE"})(K||(K={}));var l;(function(e){e[e.DISCONNECTED=0]="DISCONNECTED",e[e.CONNECTED=1]="CONNECTED",e[e.DISCONNECTING=2]="DISCONNECTING",e[e.CONNECTING=3]="CONNECTING",e[e.RECONNECTING=4]="RECONNECTING"})(l||(l={}));const w={TCP:{Port:50001,Scheme:"tcp"},TCP_TLS:{Port:50002,Scheme:"tcp_tls"},WS:{Port:50003,Scheme:"ws"},WSS:{Port:50004,Scheme:"wss"}},m={PORT:w.TCP_TLS.Port,TRANSPORT_SCHEME:w.TCP_TLS.Scheme,RECONNECT:5e3,TIMEOUT:3e4,PING_INTERVAL:1e3,CLUSTER_CONFIDENCE:1,CLUSTER_DISTRIBUTION:L.ALL,CLUSTER_ORDER:R.RANDOM,USE_BIG_INT:!1};class Ct extends X.EventEmitter{connect(t,n,r,i){if(this.tcpSocket||this.webSocket)throw new Error("Cannot initiate a new socket connection when an existing connection exists");this.timers.disconnect=setTimeout(()=>this.disconnectOnTimeout(t,n,i),i),this.once("connect",this.clearDisconnectTimerOnTimeout);const o={[w.TCP.Scheme]:"a TCP Socket",[w.TCP_TLS.Scheme]:"an encrypted TCP socket",[w.WS.Scheme]:"a WebSocket",[w.WSS.Scheme]:"an encrypted WebSocket"};if(f.network(`Initiating ${o[r]} connection to '${t}:${n}'.`),r===w.TCP.Scheme||r===w.TCP_TLS.Scheme){if(r===w.TCP_TLS.Scheme){const c={rejectUnauthorized:!1};$4QiMX$isIP(t)||(c.serverName=t),this.tcpSocket=$4QiMX$connect(n,t,c),this.tcpSocket.once("secureConnect",()=>{if(!(this.tcpSocket instanceof $4QiMX$TLSSocket))return;this.tcpSocket.authorizationError==="DEPTH_ZERO_SELF_SIGNED_CERT"&&f.warning(`Connection to ${t}:${n} uses a self-signed certificate`)}),this.tcpSocket.on("secureConnect",this.onConnect.bind(this,o[r],t,n))}else this.tcpSocket=$4QiMX$connect1({host:t,port:n}),this.tcpSocket.on("connect",this.onConnect.bind(this,o[r],t,n));this.tcpSocket.setEncoding("utf8"),this.tcpSocket.setKeepAlive(!0,0),this.tcpSocket.setNoDelay(!0),this.tcpSocket.on("error",this.eventForwarders.tcpError)}else if(r===w.WS.Scheme||r===w.WSS.Scheme)r===w.WSS.Scheme?this.webSocket=new T(`wss://${t}:${n}`):this.webSocket=new T(`ws://${t}:${n}`),this.webSocket.addEventListener("open",this.onConnect.bind(this,o[r],t,n)),this.webSocket.addEventListener("error",this.eventForwarders.wsError);else throw new Error("Incorrect transport specified")}onConnect(t,n,r){this.onConnectHasRun||(f.network(`Established ${t} connection with '${n}:${r}'.`),typeof this.tcpSocket<"u"?(this.tcpSocket.addListener("close",this.eventForwarders.disconnect),this.tcpSocket.addListener("data",this.eventForwarders.tcpData)):typeof this.webSocket<"u"&&(this.webSocket.addEventListener("close",this.eventForwarders.disconnect),this.webSocket.addEventListener("message",this.eventForwarders.wsData)),this.onConnectHasRun=!0,this.emit("connect"))}clearDisconnectTimerOnTimeout(){this.timers.disconnect&&clearTimeout(this.timers.disconnect)}disconnect(){if(this.clearDisconnectTimerOnTimeout(),this.tcpSocket)this.tcpSocket.removeListener("close",this.eventForwarders.disconnect),this.tcpSocket.removeListener("data",this.eventForwarders.tcpData),this.tcpSocket.removeListener("error",this.eventForwarders.tcpError),this.tcpSocket.destroy(),this.tcpSocket=void 0;else if(this.webSocket)try{this.webSocket.removeEventListener("close",this.eventForwarders.disconnect),this.webSocket.removeEventListener("message",this.eventForwarders.wsData),this.webSocket.removeEventListener("error",this.eventForwarders.wsError),this.webSocket.close()}catch{}finally{this.webSocket=void 0}this.onConnectHasRun=!1,this.emit("disconnect")}write(t,n){if(this.tcpSocket)return this.tcpSocket.write(t,n);if(this.webSocket)return this.webSocket.send(t,n),!0;throw new Error("Cannot write to socket when there is no active connection")}disconnectOnTimeout(t,n,r){this.removeListener("connect",this.clearDisconnectTimerOnTimeout);const i={code:"ETIMEDOUT",message:`Connection to '${t}:${n}' timed out after ${r} milliseconds`};this.emit("error",i),this.disconnect()}constructor(...t){super(...t),this.timers={},this.onConnectHasRun=!1,this.eventForwarders={disconnect:()=>this.emit("disconnect"),tcpData:n=>this.emit("data",n),wsData:n=>this.emit("data",`${n.data}
`),tcpError:n=>this.emit("error",n),wsError:n=>this.emit("error",n.error)}}}var Tt=Ct;class Nt extends X.EventEmitter{constructor(t,n,r,i=m.PORT,o=m.TRANSPORT_SCHEME,c=m.TIMEOUT,p=m.PING_INTERVAL,u=m.RECONNECT,a=m.USE_BIG_INT){if(super(),this.application=t,this.version=n,this.host=r,this.port=i,this.scheme=o,this.timeout=c,this.pingInterval=p,this.reconnectInterval=u,this.useBigInt=a,this.timers={},this.verifications=[],this.status=l.DISCONNECTED,this.messageBuffer="",!C.versionRegexp.test(n))throw new Error(`Provided version string (${n}) is not a valid protocol version number.`);this.createSocket(),typeof document<"u"&&document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this))}get hostIdentifier(){return`${this.host}:${this.port}`}createSocket(){this.socket=new Tt,this.socket.on("connect",this.onSocketConnect.bind(this)),this.socket.on("disconnect",this.onSocketDisconnect.bind(this)),this.socket.on("data",this.parseMessageChunk.bind(this))}destroySocket(){this.socket.disconnect()}parseMessageChunk(t){for(this.lastReceivedTimestamp=Date.now(),this.verifications.forEach(n=>clearTimeout(n)),this.verifications.length=0,this.messageBuffer+=t;this.messageBuffer.includes(C.statementDelimiter);){const n=this.messageBuffer.split(C.statementDelimiter);for(;n.length>1;){const r=String(n.shift());let i=Ze(r,null,this.useBigInt?Ve:parseFloat);for(Array.isArray(i)||(i=[i]);i.length>0;){const o=i.shift();if(o.id==="versionNegotiation"){o.error?this.emit("version",{error:o.error}):this.emit("version",{software:o.result[0],protocol:o.result[1]});continue}o.id!=="keepAlive"&&this.emit("statement",o)}}this.messageBuffer=n.shift()||""}}ping(){f.ping(`Sending keep-alive ping to '${this.hostIdentifier}'`);const t=C.buildRequestObject("server.ping",[],"keepAlive");return this.send(t)}async connect(){if(this.status===l.CONNECTED)return;this.status=l.CONNECTING;const t=(n,r)=>{const i=c=>{this.status=l.DISCONNECTED,r(c)};this.socket.removeAllListeners("error"),this.socket.once("error",i);const o=()=>{f.network(`Requesting protocol version ${this.version} with '${this.hostIdentifier}'.`),this.socket.removeListener("error",i);const c=C.buildRequestObject("server.version",[this.application,this.version],"versionNegotiation"),p=u=>{if(oe(u)){this.disconnect(!0);const a="unsupported protocol version.";f.errors(`Failed to connect with ${this.hostIdentifier} due to ${a}`),r(a)}else if(u.protocol!==this.version&&`${u.protocol}.0`!==this.version&&`${u.protocol}.0.0`!==this.version){this.disconnect(!0);const a=`incompatible protocol version negotiated (${u.protocol} !== ${this.version}).`;f.errors(`Failed to connect with ${this.hostIdentifier} due to ${a}`),r(a)}else f.network(`Negotiated protocol version ${u.protocol} with '${this.hostIdentifier}', powered by ${u.software}.`),this.status=l.CONNECTED,this.emit("connect"),n()};this.once("version",p),this.send(c)};this.socket.once("connect",o),this.socket.on("error",this.onSocketError.bind(this)),this.socket.connect(this.host,this.port,this.scheme,this.timeout)};await new Promise(t)}async reconnect(){await this.clearReconnectTimer(),f.network(`Trying to reconnect to '${this.hostIdentifier}'..`),this.status=l.RECONNECTING,this.destroySocket(),this.createSocket();try{await this.connect()}catch{}}clearReconnectTimer(){this.timers.reconnect&&clearTimeout(this.timers.reconnect),this.timers.reconnect=void 0}clearKeepAliveTimer(){this.timers.keepAlive&&clearTimeout(this.timers.keepAlive),this.timers.keepAlive=void 0}setupKeepAliveTimer(){this.timers.keepAlive||(this.timers.keepAlive=setTimeout(this.ping.bind(this),this.pingInterval))}async disconnect(t=!1,n=!0){if(this.status===l.DISCONNECTED&&!t)return!1;n&&(this.status=l.DISCONNECTING),await this.clearKeepAliveTimer(),await this.clearReconnectTimer();const r=i=>{this.once("disconnect",()=>i(!0)),this.destroySocket()};return new Promise(r)}async handleVisibilityChange(){document.visibilityState==="hidden"&&this.disconnect(!0,!1),document.visibilityState==="visible"&&this.reconnect()}send(t){this.clearKeepAliveTimer();const n=Date.now(),r=setTimeout(this.verifySend.bind(this,n),this.timeout);return this.verifications.push(r),this.setupKeepAliveTimer(),this.socket.write(t+C.statementDelimiter)}verifySend(t){if(Number(this.lastReceivedTimestamp)<t){if(this.status===l.DISCONNECTED||this.status===l.DISCONNECTING){f.errors(`Tried to verify already disconnected connection to '${this.hostIdentifier}'`);return}this.clearKeepAliveTimer(),f.network(`Connection to '${this.hostIdentifier}' timed out.`),this.socket.disconnect()}}onSocketConnect(){this.clearReconnectTimer(),this.lastReceivedTimestamp=Date.now(),this.setupKeepAliveTimer(),this.socket.removeAllListeners("error"),this.socket.on("error",this.onSocketError.bind(this))}onSocketDisconnect(){this.emit("disconnect"),this.clearKeepAliveTimer(),this.status===l.DISCONNECTING?(this.clearReconnectTimer(),this.removeAllListeners(),this.status=l.DISCONNECTED,f.network(`Disconnected from '${this.hostIdentifier}'.`)):(this.status===l.CONNECTED&&f.errors(`Connection with '${this.hostIdentifier}' was closed, trying to reconnect in ${this.reconnectInterval/1e3} seconds.`),this.status=l.DISCONNECTED,this.timers.reconnect||(this.timers.reconnect=setTimeout(this.reconnect.bind(this),this.reconnectInterval)))}onSocketError(t){if(!(typeof t>"u")){if(t.code==="EAI_AGAIN"){f.errors(`Failed to look up DNS records for '${this.host}'.`);return}if(t.code==="ETIMEDOUT"){f.errors(t.message);return}f.errors(`Unknown network error ('${this.hostIdentifier}'): `,t)}}}var kt=Nt;const gt=function(e){return"id"in e&&"error"in e},At=function(e){return!("id"in e)&&"method"in e};class It extends X.EventEmitter{constructor(t,n,r,i=m.PORT,o=m.TRANSPORT_SCHEME,c=m.TIMEOUT,p=m.PING_INTERVAL,u=m.RECONNECT,a=m.USE_BIG_INT){super(),this.subscriptionMethods={},this.requestId=0,this.requestResolvers={},this.connectionLock=new ke,this.connection=new kt(t,n,r,i,o,c,p,u,a)}async connect(){const t=await this.connectionLock.acquire();try{if(this.connection.status===l.CONNECTED)return;this.connection.on("statement",this.response.bind(this)),this.connection.on("connect",this.resubscribeOnConnect.bind(this)),this.connection.on("connect",this.emit.bind(this,"connected")),this.connection.on("disconnect",this.onConnectionDisconnect.bind(this)),this.connection.on("error",this.emit.bind(this,"error")),await this.connection.connect()}finally{t()}}async disconnect(t=!1,n=!1){const r=await this.connectionLock.acquire();try{n||(this.removeAllListeners(),this.subscriptionMethods={});for(const i in this.requestResolvers){const o=this.requestResolvers[i];o(new Error("Manual disconnection")),delete this.requestResolvers[i]}return await this.connection.disconnect(t)}finally{r()}}async request(t,...n){if(this.connection.status!==l.CONNECTED)throw new Error(`Unable to send request to a disconnected server '${this.connection.host}'.`);this.requestId+=1;const r=this.requestId,i=C.buildRequestObject(t,n,r),o=c=>{this.requestResolvers[r]=(p,u)=>{c(p||u)},this.connection.send(i)};return f.network(`Sending request '${t}' to '${this.connection.host}'`),new Promise(o)}async subscribe(t,...n){this.subscriptionMethods[t]||(this.subscriptionMethods[t]=new Set),this.subscriptionMethods[t].add(JSON.stringify(n));const r=await this.request(t,...n),i={jsonrpc:"2.0",method:t,params:[...n,r]};this.emit("notification",i)}async unsubscribe(t,...n){if(this.connection.status!==l.CONNECTED)throw new Error(`Unable to send unsubscribe request to a disconnected server '${this.connection.host}'.`);if(!this.subscriptionMethods[t])throw new Error(`Cannot unsubscribe from '${t}' since the method has no subscriptions.`);const r=JSON.stringify(n);if(!this.subscriptionMethods[t].has(r))throw new Error(`Cannot unsubscribe from '${t}' since it has no subscription with the given parameters.`);this.subscriptionMethods[t].delete(r),await this.request(t.replace(".subscribe",".unsubscribe"),...n),f.client(`Unsubscribed from '${String(t)}' for the '${r}' parameters.`)}async resubscribeOnConnect(){f.client(`Connected to '${this.connection.hostIdentifier}'.`);const t=[];for(const n in this.subscriptionMethods){for(const r of this.subscriptionMethods[n].values()){const i=JSON.parse(r);t.push(this.subscribe(n,...i))}await Promise.all(t)}t.length>0&&f.client(`Restored ${t.length} previous subscriptions for '${this.connection.hostIdentifier}'`)}response(t){if(At(t)){f.client(`Received notification for '${t.method}' from '${this.connection.host}'`),this.emit("notification",t);return}if(t.id===null)throw new Error("Internal error: Received an RPC response with ID null.");const n=this.requestResolvers[t.id];if(!n)throw new Error("Internal error: Callback for response not available.");delete this.requestResolvers[t.id],gt(t)?n(new Error(t.error.message)):n(void 0,t.result)}onConnectionDisconnect(){this.emit("disconnected");for(const t in this.requestResolvers){const n=this.requestResolvers[t];n(new Error("Connection lost")),delete this.requestResolvers[t]}}}var Ot=It;export{Ot as $,w as a};
//# sourceMappingURL=index.CMH9iz4U.js.map
