<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<!--link rel="icon" href="./favicon.png" /-->
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta
			property="og:title"
			content="Future Bitcoin Cash | Time-locked BCH Token Series"
		/>
		<meta property="og:url" content="https://futurebitcoin.cash/" />
		<meta property="og:image" content="https://futurebitcoin.cash/future_.webp" />
		<meta
			property="og:description"
			content="Lock Bitcoin Cash as time-locked fungible tokens with coupons from an open market."
		/>
		<meta property="og:type" content="website" />
		<meta property="og:article:section" content="Technology" />
		<meta property="og:article:tag" content="Future Bitcoin Cash" />
		<meta property="og:article:tag" content="Bitcoin Cash" />
		<meta property="og:article:tag" content="Futures" />
		<meta property="og:locale" content="en" />
		<link rel="manifest" href="manifest.json" />
		<style>
			@import url('https://fonts.googleapis.com/css2?family=Anybody:ital,wght@0,100..900;1,100..900&display=swap');
		</style>
		<script src="https://unpkg.com/@bitjson/qr-code@1.0.2/dist/qr-code.js"></script>
		
		<link href="./_app/immutable/assets/0.C48m0qV9.css" rel="stylesheet">
		<link href="./_app/immutable/assets/SvelteToast.BAXstrkn.css" rel="stylesheet"><title>Audit</title><!-- HEAD_svelte-vrcfmi_START --><!-- HEAD_svelte-vrcfmi_END -->
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents">  <div class="app svelte-8o1gnw"><div class="warn svelte-wavrw1" data-svelte-h="svelte-wuhrry">Pre-alpha pre-release. Use at your own risk.<br>
	Bugs and usability issues may result in loss of funds.</div> <div class="wallet svelte-wavrw1"></div> <header class="svelte-wavrw1"><div class="corner svelte-wavrw1" data-svelte-h="svelte-9hijgq"><a href="/" class="svelte-wavrw1"><img src="/FBCH.svg" alt="Home" class="svelte-wavrw1"></a></div> <nav class="svelte-wavrw1"><svg viewBox="0 0 2 3" aria-hidden="true" class="svelte-wavrw1"><path d="M0,0 L1,2 C1.5,3 1.5,3 2,3 L2,0 Z" class="svelte-wavrw1"></path></svg> <ul class="svelte-wavrw1"><li style="font-weight: 900;" class="svelte-wavrw1"><a style="font-size: larger" href="/" class="svelte-wavrw1" data-svelte-h="svelte-xqmuyf"><b>ⓘ</b></a></li> <li class="svelte-wavrw1"><a href="/vaults" class="svelte-wavrw1" data-svelte-h="svelte-18ikwbv">Vaults</a></li> <li class="svelte-wavrw1"><a href="/write" class="svelte-wavrw1" data-svelte-h="svelte-1rwkpbp">Write</a></li></ul> <svg viewBox="0 0 2 3" aria-hidden="true" class="svelte-wavrw1"><path d="M0,0 L0,3 C0.5,3 0.5,3 1,2 L2,0 Z" class="svelte-wavrw1"></path></svg></nav> <div class="status svelte-wavrw1"></div> </header> <ul class="_toastContainer svelte-yh90az"> </ul> <main class="svelte-8o1gnw"><nav class="toc" data-svelte-h="svelte-z0t0wl"><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#introduction">Introduction</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#overview">Overview</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#vault">Vault</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#coupon">Coupon</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#gantry">Gantry</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#battery">Battery</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#final-review">Final Review</a></li></ol></nav>  <blockquote data-svelte-h="svelte-1v3xnaw"><p>Although Vault and Coupon contracts are identical to the audit,</p> <h3 id="the-gantry-and-battery-contracts-were-modified-as-noted-in-the-comments-of-the-final-versions">the <a href="/contracts#gantry">Gantry</a> and <a href="/contracts#battery">Battery</a> contracts were modified as “NOTED” in the comments of the final versions.</h3></blockquote> <blockquote data-svelte-h="svelte-kmjeku"><p>Also note: the scope of the audit pertained to the on-chain contracts and the intended function of the overall contract system. Software such as wallets, plugins and libraries that interact with the contracts (like this webapp or software) are beyond the scope of the audit.</p></blockquote> <h1 id="introduction" data-svelte-h="svelte-1eaztqk">Introduction</h1> <p data-svelte-h="svelte-uzdvmk">This is an audit report on “Future Bitcoin Cash” system of Bitcoin Cash (BCH) smart contracts, made at request of 2qx.</p> <blockquote data-svelte-h="svelte-nzdzo1"><p>Memorandum of Understanding - Future Bitcoin Cash Audit</p></blockquote> <blockquote data-svelte-h="svelte-1ha58tz"><p>2024-04-26  2qx to BCA</p></blockquote> <blockquote data-svelte-h="svelte-ddv20k"><p>This is a memorandum of understanding between 2qx, (“Client”) and bitcoincashautist (a.k.a. BCA, “the Auditor”) for a review and written audit report of “Future Bitcoin Cash” contracts.</p></blockquote> <blockquote data-svelte-h="svelte-1m40m4f"><p>The Client proposes the audit will proceed in two phases.</p></blockquote> <blockquote data-svelte-h="svelte-1sybfa5"><p>First, and initial assessment will be given of potential flaws or mistakes in the workflow or logic of the contract system. Second, once the Client has revised the contracts with improvements and corrections, the Auditor may prepare a written report on the security of the contracts.</p></blockquote> <blockquote data-svelte-h="svelte-1mgjbpm"><p>The scope of the report should address near and long term security concerns, but may be limited to the on-chain operation of the permanent contracts. The report may omit any consideration of one-time use bootstrapping contracts (i.e. the Battery). The report should address post-quantum and quantum-resistant concerns of the double-sha256 script locking mechanisms on the long term viability of the system. The report should note any potential for DDoS or other network attack vectors.</p></blockquote> <blockquote data-svelte-h="svelte-1ctauez"><p>The Auditor’s report must be submitted in markdown format to be hosted by the Client in the final app.</p></blockquote> <blockquote data-svelte-h="svelte-swz0ij"><p>The Auditor’s fee will be conveyed in Future Bitcoin fungible tokens. The fee will be conveyed as 2 FBCH UTXOs from each of the premiere vaults of the five timescale tranches, a total of 10 FBCH. To prevent the Client from the unsavory misfortune of holding a BCH-pegged liability, the Auditor will custody the 10 BCH necessary for creation of his FBCH tokens between the completion of the audit and the completion of the app. Once the Auditor retrieves his 2 FBCH x 5 from the premiere vaults, those FBCH tokens shall be considered by all parties to be free and unencumbered from any obligations or earmarks, i.e. that Auditor has been fully paid and may degen his Futures at will.</p></blockquote> <blockquote data-svelte-h="svelte-kvyzp2"><p>This is a non-binding memorandum of understanding without contingency.</p></blockquote> <code style="line-break:anywhere" data-svelte-h="svelte-5znn7x">Signed: `H1ErlyrktMt2a5tRzWHfjQkbpNtOCtH/QWcKaR3bRcCkRLmQDuJ3ufDDMe2/83bclcZmyIcHeDk7v4Uku3vhZpw=`</code> <h1 id="overview" data-svelte-h="svelte-oeodtg">Overview</h1> <p data-svelte-h="svelte-1u2s686">Future Bitcoin Cash (FBCH) fungible tokens will essentially be instances of <a href="https://wrapped.cash/" rel="nofollow">wrapped BCH tokens</a> with additional clause that they can’t be unwrapped until the timelock expires.</p> <p data-svelte-h="svelte-1kbm94n">The contracts system will consist of 4 contracts: Battery, Gantry, Vault, and Coupon.</p> <p data-svelte-h="svelte-1ymnonb">From the point-of-view of someone getting paid in FBCH, his only concern is to audit the Vault contract and its genesis transaction, because it is the Vault that holds the backing BCH and underwrites the emitted FBCH.</p> <p data-svelte-h="svelte-fx1obe">Coupon is a simple one-time covenant that can be used with some Vault instance in order to get a discount when minting FBCH.</p> <p data-svelte-h="svelte-o8c33d">Battery and Gantry contracts are constructor contracts, contracts whose purpose is to create new instances of other contracts or tokens, according to specification.
The Battery will spawn a sequence of Gantries, and each Gantry will spawn a sequence of Vaults.</p> <p data-svelte-h="svelte-1qt218x">This will make it easier for any holder to audit FBCH genesis, as we only need to audit the contract system once, and from then on anyone interested in soundness of his FBCH can simply check that it has a Battery TXO of the correct category as ancestor, instead of having to analyze each Vault instance.</p> <h1 id="vault" data-svelte-h="svelte-1ndpua0">Vault</h1> <p data-svelte-h="svelte-5lx7ln">We will start with the most important contract - one which underwrites every emitted unit of FBCH.</p> <h2 id="vault-summary" data-svelte-h="svelte-aterrh">Vault Summary</h2> <p data-svelte-h="svelte-1xrkwi0">We find the contract to be doing what it intends to be doing:</p> <blockquote data-svelte-h="svelte-7dmpho"><p>Vault - Store coins locked for tokens until maturation date.</p></blockquote> <p data-svelte-h="svelte-vjew9m">Put simply, the contract can be used as follows:</p> <ul data-svelte-h="svelte-1pvsrlg"><li>if timelock has expired then it can be used to unwrap/wrap BCH from/to token</li> <li>if timelock has not expired then it can be used only to wrap BCH to token</li></ul> <p data-svelte-h="svelte-2bqyb4">and we found no way to break the contract, assuming it was instantiated properly (entirety of supply given to the contract in token category genesis TX).</p> <p data-svelte-h="svelte-abunn0">We have some suggestions for improvement and optimization, please see analysis below.</p> <h2 id="vault-contract-analysis" data-svelte-h="svelte-4j0ufc">Vault Contract Analysis</h2> <pre class="language-javascript"><!-- HTML_TAG_START --><code class="language-javascript">contract <span class="token function">Vault</span><span class="token punctuation">(</span><span class="token parameter">bytes4 locktime<span class="token punctuation">,</span> bytes32 tokenCategory</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-1qk27yj">There is no need to specify locktime as <code>bytes4</code>.
Natively the locktime is treated as a script number, so <code>int</code> type would be more appropriate, and use of <code>int(locktime)</code> could be avoided in the code below and save a byte (OP_BIN2NUM) in compiled bytecode.
As we will see later, the Vault bytecode is intended to be constructed by the Gantry contract, and use of fixed-size constructor parameter here could make that easier.
We’re not convinced it is the best approach, because it is easy enough to generate a push sequence from a script number, especially if the number can be guaranteed to be greater than 16.</p> <pre class="language-javascript"><!-- HTML_TAG_START --><code class="language-javascript">        bool tokensRedeemed <span class="token operator">=</span> <span class="token punctuation">(</span>
          tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount 
          <span class="token operator">-</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount
          <span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-oto039">This is a good way to check that the user is attempting to unwrap.
Usage of <code>this.activeInputIndex</code> in this way works similar to SIGHASH_ONE.</p> <pre class="language-undefined"><!-- HTML_TAG_START --><code class="language-undefined">        bool toVault = tx.outputs[this.activeInputIndex].lockingBytecode 
                 == new LockingBytecodeP2SH32(hash256(this.activeBytecode));</code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-t07hcu">On its own, this code would force a wrongly instantiated thread (P2SH20) to mutate to P2SH32 on first usage, but it would also mean that the check becomes unnecessary from then on.
Note that, because of other code below, instantiating the contract as P2SH20 would break the unwrap path.</p> <p data-svelte-h="svelte-1vqw7yq">Generally, we recommend against enforcing P2SH32 by the contract’s code.
Recursive covenant can be enforced more simply with:</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">        <span class="token builtin">bool</span> toVault <span class="token operator">=</span> tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode 
                 <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode<span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-1ayo4c4">This way, if properly instantiated as P2SH32 it will still remain P2SH32 for the lifetime of the contract thread.
Likewise, if wrongly instantiated as P2SH20 it will remain P2SH20.
Instead of encumbering even properly instantiated contracts with extra checks it should be responsibility of the app to instantiate the contract properly.</p> <p data-svelte-h="svelte-vqymoo">In any case, the <code>toVault</code> here is redundant, because code further below makes it so that, for properly instantiated contract (P2SH32), it’s not possible for <code>toVault</code> to ever be false.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">        <span class="token keyword">if</span><span class="token punctuation">(</span>toVault <span class="token operator">&amp;&amp;</span> tokensRedeemed<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>time <span class="token operator">>=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>locktime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tokenCategory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> </code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-1v3ojtp">Good approach to enforce locktime only for the case of token redemption.
However, the token category check is redundant and can be removed, unless the intent is to have contract address be specifically usable only with the particular token category.
This check wouldn’t prevent dusting the contract address with BCH or other token categories - it would just make all such UTXOs unspendable.</p> <p data-svelte-h="svelte-1swespg">We recognize that hard-coding the categoryID would make it easier to use Electrum API to look up history of a particular token locked with the contract, and understand the choice due to current state of CashTokens infrastructure.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">        <span class="token keyword">require</span><span class="token punctuation">(</span>
          tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory 
          <span class="token operator">==</span> 
          tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory
          <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">require</span><span class="token punctuation">(</span>
          tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode 
          <span class="token operator">==</span> 
          tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode
          <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">require</span><span class="token punctuation">(</span>
          tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">+</span> 
          tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>value 
          <span class="token operator">==</span> 
          tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">+</span> 
          tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>value
         <span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-o8id78">Straight-forward way to enforce unwrapping/wrapping BCH from/to token, as already seen in <a href="https://bitcoincashresearch.org/t/wbch-bch-wrapped-as-cash-token/1196" rel="nofollow">wrapped.cash</a>.
This code makes some of the above code redundant, as already indicated above.</p> <h2 id="vault-contract-design-notes" data-svelte-h="svelte-5sl7s5">Vault Contract Design Notes</h2> <p data-svelte-h="svelte-hbdke">As it is, the contract can be used to wrap BCH even after timelock expiry.
We suggest to consider adding a NFT state to the Vault contract so that it can’t be used for wrapping after timelock expires.</p> <p data-svelte-h="svelte-1owucpb">As it is, the contract will always leave 1 UTXO, even if never used.
We suggest to consider adding a clean-up spending path, so the contract can be burned at end of its lifetime, if all tokens are returned after the timelock.</p> <h2 id="notes-on-vault-edge-cases" data-svelte-h="svelte-1ufob9y">Notes on Vault Edge Cases</h2> <p data-svelte-h="svelte-1rskgrv">The creator can instantiate the category with any number of UTXOs and split fungible token supply across them.</p> <p data-svelte-h="svelte-1u4uwgl">Unless the creator has access to hashrate (which would allow him to circumvent network relay rules), each UTXO will have to be created with a dust amount of BCH.</p> <p data-svelte-h="svelte-i2rqr6">Someone with hashrate could then wrap some BCH by interacting with 1 of the available UTXOs, and then (if timelock has expired) use the obtained wrapped BCH to deplete all other BCH UTXOs down to 0 BCH and make the threads unusable for regular users.
However, one thread is still guaranteed to remain usable, because entirety of token-backing BCH will end up with that 1 UTXO.</p> <p data-svelte-h="svelte-1x05c3q">Similarly, after timelock expiry, anyone can spend all contract UTXOs together and move entirety of BCH (sans the dust) to just 1 UTXO, without needing to lock up any of his own BCH.
This would force wrapped token holders to use only that 1 thread until someone would wrap using one of the other threads.</p> <p data-svelte-h="svelte-1h9lhoh">Any regular user can obtain some wrapped BCH and then use it to create more UTXOs of the contract by funding them each with at least 1 token unit and dust amount of BCH.
There’s no incentive to ever do this, because the user would only be losing money if he would do this.</p> <p data-svelte-h="svelte-13tuz8k">If the category is instantiated with too low fungible token supply, then it would place a limit on how much BCH can be wrapped in total, and if multiple UTXOs exist it would allow for the possibility of reduction of number of threads.
This is trivial to prevent: at genesis, each UTXO should enough fungible tokens to be able to wrap whole BCH supply on its own.</p> <p data-svelte-h="svelte-1wy1pmy">At the limit, wrapping is multi-threaded until timelock, and unwrapping is single-threaded.
If single-threaded use is acceptable, then the contract needs no change.</p> <p data-svelte-h="svelte-uo7hev">If multi-threaded is desirable, then this contract code needs to be expanded, and that would come with caveats because the trade-off would be increasing contract size and with that the TX fee.</p> <p data-svelte-h="svelte-1vykheb">Adopting the above suggestion of prohibiting wraps after timelock expiry would somewhat improve the multi-threadedness because only previous token holders could deplete individual threads of BCH and only if they had previously obtained enough FBCH.</p> <h2 id="notes-on-vault-p2sh-collision" data-svelte-h="svelte-r30978">Notes on Vault P2SH Collision</h2> <p data-svelte-h="svelte-2be2oq">With hard-coded categoryID, the creator of category &amp; contract would have enough degrees of freedom to attempt to brute-force categoryID (on creation) in order to find two redeem scripts that hash to the same P2SH20 address.
With P2SH32 that would be computationally infeasible therefore P2SH32 is recommended for the original contract code.</p> <p data-svelte-h="svelte-ivnkwe">The original contract code is such that a P2SH20 variant unusable for users anyway, and creator would have nothing to gain from having an alternative, secret, redeem script available to him.</p> <p data-svelte-h="svelte-d71jzz">Users of the contract can’t attempt a collision search anyway, because contract code enforces exact bytecode to be passed on.</p> <p data-svelte-h="svelte-1pqrk8o">If P2SH32 enforcement code would be removed, users should be aware of the need to verify that the contract was instantiated as P2SH32, as part of their due diligence on the app.</p> <p data-svelte-h="svelte-2b2gcl">Users are expected to perform some due diligence on the contract in any dapp they use, anyway, so having the P2SH32 check in the contract code itself doesn’t relieve them of their due diligence.</p> <h2 id="notes-on-vault-quantum-security" data-svelte-h="svelte-1fy1khe">Notes on Vault Quantum Security</h2> <p data-svelte-h="svelte-y4ktdq">The P2SH32 variant is quantum secure against quantum preimage search because it would still be a 2<sup>128</sup> problem, even for quantum computers.
It is still theoretically vulnerable to quantum collision search, as it would be a 2<sup>85</sup> problem for quantum computers.</p> <p data-svelte-h="svelte-8zycsm">Wihout some scientific breakthrough, a 2<sup>85</sup> problem would still be <a href="https://crypto.stackexchange.com/questions/102574/could-grovers-algorithm-perform-a-search-in-n-2-for-a-match-in-a-particular-sub" rel="nofollow">impractical</a>.</p> <p data-svelte-h="svelte-1tmali8">In any case, due to nature of the contract, collision search attempt is possible only before contract instantiation and therefore P2SH32 contracts created before availability of hypothetical quantum computers would remain safe to use even after availability of such computers.</p> <h2 id="notes-on-vault-proper-category-initialization" data-svelte-h="svelte-1p4s2mf">Notes on Vault Proper Category Initialization</h2> <p data-svelte-h="svelte-19745ow">The genesis transaction MUST NOT create any token UTXOs locked with any other bytecode than the Vault contract’s P2SH32 address.</p> <p data-svelte-h="svelte-q2iv7o">The genesis transaction SHOULD NOT create any NFTs.</p> <p data-svelte-h="svelte-u5u0ti">The genesis transaction SHOULD create enough fungible token supply so that entirety of BCH supply can be wrapped.</p> <h2 id="vault-alternative-contract" data-svelte-h="svelte-1xfgtju">Vault Alternative Contract</h2> <p data-svelte-h="svelte-7a7cug">Below we present contract code with the above suggestions implemented.</p> <p data-svelte-h="svelte-3miinn">Because hardcoded categoryID is removed, this contract’s bytecode pattern doesn’t offer enough degrees of freedom for a P2SH20 collision search.
The locktime offers only 4 bits of freedom, and some values would make it unusable or unconvincing, further reducing practically usable degrees of freedom.</p> <p data-svelte-h="svelte-xylu1j">Permutations of lines of contract code (and resulting bytecode) would possibly allow a few more bits for the search, but it would be obvious to anyone that the below presented code was changed without a plausible reason.</p> <p data-svelte-h="svelte-6b2oio">For this reason, the below code is expected to be safe to use even as P2SH20.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">Vault</span><span class="token punctuation">(</span><span class="token builtin">int</span> locktime<span class="token punctuation">,</span> <span class="token builtin">int</span> maxSupply<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">function</span> <span class="token function">TerminateOrSwap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> <span class="token number">0x6a</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token comment">// If the vault is being terminated then</span>
            <span class="token comment">// locktime must be expired...</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>time <span class="token operator">>=</span> locktime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ...and the exact amount of tokens already returned to</span>
            <span class="token comment">// the Vault instance which is getting burned...</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span>
                maxSupply<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ...and the remaining dust either burned or donated</span>
            <span class="token comment">// to miners.</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

            <span class="token comment">// If tokens are flowing back into this contract</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">></span>
                tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount
            <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// enforce a BIP65 timelock </span>
                <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>time <span class="token operator">>=</span> locktime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// Pass on the token category &amp; capability</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span>
                tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Pass on the contract</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> 
                tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Pass on bch+token balance</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">+</span>
                tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> 
                tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">+</span> 
                tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre> <h1 id="coupon" data-svelte-h="svelte-1grnp6w">Coupon</h1> <h2 id="coupon-summary" data-svelte-h="svelte-38p3cn">Coupon Summary</h2> <p data-svelte-h="svelte-1pdw4fj">Coupon is a simple one-time covenant that releases its funds only if some minimum amount of BCH is paid into a particular locking bytecode.</p> <p data-svelte-h="svelte-q8m4q2">We found an error in the contract that would break it from performing the intended purpose.
With the error fixed, the contract can be considered fit for purpose of incentivizing interaction with Vault contracts.</p> <h2 id="coupon-contract-analysis" data-svelte-h="svelte-t064lw">Coupon Contract Analysis</h2> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">>=</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-r32fb0">This doesn’t check whether something was added to the Vault.
It is possible that the Vault already had enough BCH because another user previously interacted with it.
In this case the coupon would be free money, since user wouldn’t have to add his own BCH to the Vault.</p> <p data-svelte-h="svelte-b2r2si">The above should be changed to <code>require(tx.outputs[0].value - tx.inputs[0].value &gt;= amount);</code>.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> lock<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-17rpwhd">The covenant only requires a matching locking script, however it doesn’t check for a particular instance of the Vault.
This allows for use of any Vault instance with matching parameters, or even for creation of a brand new Vault instance in the same TX that spends the coupon, or a broken (unspendable) instance.
Even so, the spender will still be required to lock his own BCH, which will remain locked until Vault’s timelock expires.</p> <p data-svelte-h="svelte-55ka0p">We can prohibit Vault genesis and broken instances simply by requiring the locking bytecode on the input instead of on the output:</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> lock<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-1be5o6y">When <code>lock</code> is targeting the Vault bytecode, the output locking bytecode will still be enforced by transience: the Coupon requires Vault be spent in index 0 input, and the Vault being spent in index 0 input will require that it is passed on to index 0 output.</p> <p data-svelte-h="svelte-1nvdfa7">Anyone can create an instance of Vault before hand and spend the Coupon with his instance.
If it is desired to target a particular instance, then the Coupon should require a particular categoryID, but that would increase the size of the Coupon contract.</p> <p data-svelte-h="svelte-1oesjvd">Alternatively, the Vault could be redesigned so that each instance carries an NFT such that it can’t be separated from the Vault bytecode, in which case the Coupon could target the NFT and the locking bytecode requirement could be dropped.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">require</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-ncycto">Flexible way to restrict TX to just 1 Coupon. This allows the user to add any number of other inputs between index 0 and the last index.</p> <h2 id="coupon-alternative-contract" data-svelte-h="svelte-lxpjzg">Coupon Alternative Contract</h2> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">Coupon</span><span class="token punctuation">(</span>

  <span class="token comment">// Minimum spent to claim the coupon.</span>
  <span class="token builtin">int</span> amount<span class="token punctuation">,</span>
  
  <span class="token comment">// Destination for the zeroth (constraining) output.</span>
  <span class="token builtin">bytes</span> lock

<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

  <span class="token keyword">function</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
    <span class="token comment">// assure at the minium amount is sent as the first output</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">-</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">>=</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

    <span class="token comment">// Check that the Coupon is interacting with an existing Vault instance</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token comment">// The coupon must be spent as the last input, </span>
    <span class="token comment">//   therefore only coupon may be spent at a time.</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre> <h1 id="gantry" data-svelte-h="svelte-1px4dhc">Gantry</h1> <p data-svelte-h="svelte-aj6iax">The Gantry ensures that Vault genesis transactions are properly initializing Vault token categories.
The benefit of having instances of Vault created by a Gantry is that any instance of Vault can be easily audited:</p> <ol data-svelte-h="svelte-1fot84y"><li>Look up the TX where TXID == vaultCategoryID, that is the Vault’s “pre-genesis” TX.</li> <li>Verify that the 1st output of the pre-genesis TX has the Gantry contract code.</li></ol> <p data-svelte-h="svelte-1a1rvvr">This is proof enough that the Vault was created according to specification, because Gantry code is known, and by auditing that it properly enforces specification we can validate Vault genesis TX without actually seeing it.</p> <p data-svelte-h="svelte-1mu4pxc">This is convenient because then we don’t need to use an indexer to look up the genesis TX, and so any FBCH can be audited simply by querying any node for the pre-genesis TX.</p> <h2 id="gantry-summary" data-svelte-h="svelte-146gz8f">Gantry Summary</h2> <p data-svelte-h="svelte-ax0spw">We find the contract to be doing what it intends to be doing.</p> <blockquote data-svelte-h="svelte-n9card"><p>Gantry - Create vault contracts with fungible tokens in a uniform way.</p></blockquote> <p data-svelte-h="svelte-808cll">The contract is intended as a single thread recursive covenant that uses a mutable NFT’s commitment to keep track of the next Vault instance’s <code>timelock</code> parameter.
We found no way to break the contract, assuming it was instantiated properly (single mutable NFT created and given to the contract in token category genesis TX).</p> <p data-svelte-h="svelte-abunn0">We have some suggestions for improvement and optimization, please see analysis below.</p> <h2 id="gantry-contract-analysis" data-svelte-h="svelte-1lj82hc">Gantry Contract Analysis</h2> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-j0puqh">Using a hard-coded input &amp; output index without additional guards is dangerous because on its own it would make it possible to spend 2 UTXOs with the same contract as both index 0 and index 1, possibly making them interact in unintended ways, or even allow a forged UTXO to be spent as index 0 and cheat the covenant.</p> <p data-svelte-h="svelte-1wnipgw">As it is, the contract doesn’t limit the number of inputs or explicitly enforce this contract to be executed as input 0, which makes it hard to reason about whether it can be broken or not.</p> <p data-svelte-h="svelte-1dmzkv">Because the contract code commits to a hardcoded <code>categoryID</code> and requires it on both index 0 input and index 0 output, then if placed on an NFT of the same category the NFT can’t escape from the covenant, assuming the category was instantiated properly (created exactly 1 mutable NFT output in genesis TX).
However, this kind of constraint leaves the contract open to some benign side-effects: the same contract can be placed on a pure BCH or another token category, in which case those UTXOs could be freely spent as inputs added to a TX spending the proper UTXO in index 0.</p> <p data-svelte-h="svelte-1hcm1ul">When UTXO has to pass its own state to a new output, it’s recommended to use <code>[this.activeInputIndex]</code> index instead of <code>[0]</code>.
Both will result in same size of compiled bytecode, but the former makes the programmer’s intent more obvious.</p> <p data-svelte-h="svelte-1dzz3a3">If the contract thread has to live in index 0 then we recommend explicitly requiring it:</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">require</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-rpqjdh">to be sure that it is <em>this</em> UTXO that is satisfying other requirements on index 0 input, and not some other UTXO.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> tokenCategory<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-e8bgnl">There is no need to hardcode <code>tokenCategory</code>, for same reasons as with the Vault contract.</p> <p data-svelte-h="svelte-1l1g9nv">If Gantry is correctly instantiated (genesis TX created single output of the category with mutable NFT and encumbered with the Gantry contract), then the next line:</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-enuk9b">will suffice to enforce correctly passing on the token category.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-os6ouv">If the Gantry category was instantiated without fungible tokens, then the above line is unnecessary.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token builtin">int</span> step <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>stepBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">int</span> locktime <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">bytes4</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token builtin">bytes4</span><span class="token punctuation">(</span>locktime<span class="token operator">+</span>step<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-id2va8">This enforces the mutable NFT to increment the stored state, but it forces the script number to be stored as <code>bytes4</code> fixed width LE integer in the NFT’s commitment.
It could work the same if script number was stored directly, to avoid casting overheads.
However, benefit of storing a number as fixed width LE integer is that generic block explorers etc. are likely to parse and display the number correctly (as opposed to parsing script numbers, support for which is not widespread).
The NFT and contract code will be slightly bigger than the alternative but since there will only be 1 NFT of the category in existence this is a good trade-off.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>locktime<span class="token operator">/</span>step<span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">10</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> 
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-yddebt">Every 10th spend from this contract just increments the NFT’s state without doing anything else.
The reason for this is to avoid overlap with other instances of this contract, as we will see when we get to analyzing the Battery contract.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">            <span class="token builtin">bytes</span> theVault <span class="token operator">=</span> 
                <span class="token number">0x20</span> <span class="token operator">+</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outpointTransactionHash <span class="token operator">+</span>   <span class="token comment">// new fungible category</span>
                <span class="token number">0x04</span> <span class="token operator">+</span> <span class="token builtin">bytes4</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment<span class="token punctuation">)</span> <span class="token operator">+</span>     <span class="token comment">// locktime</span>
                vaultUnlockingBytecode<span class="token punctuation">;</span>    
            <span class="token builtin">bytes</span> vaultLockingBytecode <span class="token operator">=</span> <span class="token number">0xaa20</span> <span class="token operator">+</span> <span class="token function">hash256</span><span class="token punctuation">(</span>theVault<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x87</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-101i8ld">This generates the locking bytecode for the Vault instance created in this spend.</p> <p data-svelte-h="svelte-1f56co5">We already commented that Vault could remove the categoryID, and use native script numbers.
In that case, the above code could be reworked to:</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">            <span class="token builtin">int</span> lockTime <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment<span class="token punctuation">)</span>
            <span class="token builtin">bytes</span> theVault <span class="token operator">=</span> 
                <span class="token builtin">bytes</span><span class="token punctuation">(</span>lockTime<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>lockTime<span class="token punctuation">)</span> <span class="token operator">+</span>     <span class="token comment">// push locktime</span>
                vaultUnlockingBytecode<span class="token punctuation">;</span>    
            <span class="token builtin">bytes</span> vaultLockingBytecode <span class="token operator">=</span> <span class="token number">0xaa20</span> <span class="token operator">+</span> <span class="token function">hash256</span><span class="token punctuation">(</span>theVault<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x87</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-g8crh6">Assuming Gantry was instantiated correctly (with a 4-byte timestamp and initial commitment greater than 16), we can be sure that the generated push sequence will be correct.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> vaultLockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>       
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outpointTransactionHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span> <span class="token number">300000000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     </code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-15h4d5q">The bytecode and category checks are sound.
It would be good to require a dust BCH amount as well, else someone with access to hashrate could temporarily block normal operation by depleting the outputs of dust.</p> <p data-svelte-h="svelte-1dk394w">This still allows for creation of immutable NFTs with commitment decided by the spender.
We can restrict it to empty commitment with <code>require(tx.outputs[1].nftCommitment == 0x);</code>.
However, this will still allow creation of empty immutable NFTs.
Those will be a benign side-effect, and as it is the contract can’t prohibit them due to how CashTokens introspection opcodes were designed (more info <a href="https://github.com/cashtokens/cashtokens/issues/29" rel="nofollow">here</a>).</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">            <span class="token builtin">bytes</span> announcement <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LockingBytecodeNullData</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token number">0x46424348</span><span class="token punctuation">,</span>
                <span class="token builtin">bytes</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> announcement<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-7edz6g">If instantiated properly then there is no need for <code>.split(4)[0]</code> when contract code already enforces the commitment to be <code>bytes4</code>.
Because we know that proper instances will have exact 4 bytes of commitment, then we can hardcode the OP_RETURN &amp; push opcodes:</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token builtin">bytes</span> announcement <span class="token operator">=</span> <span class="token number">0x6a044642434804</span> <span class="token operator">+</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment<span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-1j4fuk6">which will compile to <code>&lt;0x6a044642434804&gt; OP_ACTIVEINPUTINDEX OP_UTXOCOMMITMENT OP_CAT</code>.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">            <span class="token comment">// Is this check necessary if the op_return is used?</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-1fzdjce">It is recommended, and adding <code>require(tx.outputs[8].tokenCategory == 0x);</code> would be good, too.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">            <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-1dt42xm">This ensures that tokens of the new category can’t “leak” outside the Vault contract.
If number of generated outputs is to be changed then this must be updated as well.
Also, the <code>int()</code> cast is redundant and can be removed.</p> <h2 id="gantry-contract-design-notes" data-svelte-h="svelte-1s8xkdh">Gantry Contract Design Notes</h2> <p data-svelte-h="svelte-1b1kc38">As it is, anyone can evolve the Gantry contract to create lots of instances Vault with timelocks far into the future.
If this is undesirable, then use of Gantry should be timelocked, too.</p> <p data-svelte-h="svelte-1dsyymn">Similarly, if Gantry didn’t issue Vaults for a while and last one created is in the past, then later it could be minting more instances of Vault with timelocks already expired, just to evolve until the instance that’s actually desired.
If this is undesirable, then timeskip option could be added to the contract.</p> <h2 id="notes-on-gantry-edge-cases" data-svelte-h="svelte-1qqmuey">Notes on Gantry Edge Cases</h2> <p data-svelte-h="svelte-16w0edc">If the <code>step</code> parameter is negative, then contract could still be used to mint some proper instances of Vault, if the genesis output’s NFT is initialized with some commitment that encodes a timestamp in the future.
However, the contract will become useless as soon as the last created Vault has <code>locktime</code> in the present, and later create broken instances if arrives to below 0.</p> <p data-svelte-h="svelte-sk583f">If the <code>step</code> parameter is 0, then the contract will be useless because it can create unlimited instances of Vault with same locktimes.</p> <p data-svelte-h="svelte-1575t33">If the commitment is bigger than 4 bytes, then the contract will be broken.</p> <p data-svelte-h="svelte-qi16m9">If the commitment is less than 4 bytes, the contract will work and only the genesis output will have a commitment less than 4 bytes, because first spend will enforce padding to 4 bytes.</p> <p data-svelte-h="svelte-9w5ufi">If the <code>commitment</code> + <code>step</code> would become greater than 4 bytes, then the contract thread will halt / become unspendable.</p> <h2 id="notes-on-gantry-p2sh-collision-and-quantum-security" data-svelte-h="svelte-4xzw77">Notes on Gantry P2SH Collision and Quantum Security</h2> <p data-svelte-h="svelte-1hu5h1n">Same comments as for Vault apply.</p> <h2 id="notes-on-gantry-proper-category-initialization" data-svelte-h="svelte-1qa5m5f">Notes on Gantry Proper Category Initialization</h2> <p data-svelte-h="svelte-10tj8e3">The genesis transaction MUST create one NFT with mutable capability and locked with the Gantry contract’s P2SH32 address.</p> <p data-svelte-h="svelte-yhy54w">The <code>step</code> parameter MUST be a positive, greater than 0 integer, and less than INT4_MAX value.</p> <p data-svelte-h="svelte-2t8k52">The <code>commitment</code> SHOULD be initialized as 0-padded LE 4-byte integer.</p> <p data-svelte-h="svelte-5wmz1j">The <code>commitment</code> MUST be a small enough value to allow at least one spend from the contract.</p> <p data-svelte-h="svelte-7wmm5w">The Gantry genesis transaction MUST NOT create multiple token UTXOs of the category.</p> <p data-svelte-h="svelte-264wdm">The Gantry genesis transaction MUST NOT create fungible tokens.</p> <h2 id="gantry-alternative-contract" data-svelte-h="svelte-1j8tvae">Gantry Alternative Contract</h2> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">Gantry</span><span class="token punctuation">(</span>
    <span class="token builtin">int</span> step<span class="token punctuation">,</span> 
    <span class="token builtin">bytes</span> vaultUnlockingBytecode
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">function</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Gantry covenant and the associated NFT baton must be spent as index 0</span>
        <span class="token comment">// input and passed on to index 0 output, funded with some dust BCH in order</span>
        <span class="token comment">// to avoid griefing by someone with access to hashrate</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span>
            tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span>
            tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">></span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Read a bytes4 LE commitment and convert to script number</span>
        <span class="token builtin">int</span> locktime <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Allow time-skip in case Vault to be minted has already expired</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>locktime <span class="token operator">&lt;=</span> tx<span class="token punctuation">.</span>locktime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            locktime <span class="token operator">=</span> <span class="token punctuation">(</span>tx<span class="token punctuation">.</span>locktime <span class="token operator">/</span> step <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> step<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token builtin">int</span> nextLocktime <span class="token operator">=</span> locktime <span class="token operator">+</span> step<span class="token punctuation">;</span>

        <span class="token comment">// Prevent the spender from rolling over from height-based timelock</span>
        <span class="token comment">// to timestamp-based timelock.</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>nextLocktime <span class="token operator">&lt;</span> <span class="token number">500000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Locktime stored in mutable NFT commitment MUST be incremented by &lt;step></span>
        <span class="token comment">// and stored as bytes4 LE uint again.</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span>
            <span class="token builtin">bytes4</span><span class="token punctuation">(</span>nextLocktime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Every 10th step, skip creating Vault and just increment the commitment</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>locktime <span class="token operator">/</span> step<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Construct redeem bytecode for the Vault instance being created</span>
            <span class="token builtin">bytes</span> theVault <span class="token operator">=</span> 
                <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>locktime<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>locktime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token comment">// int locktime</span>
                vaultUnlockingBytecode<span class="token punctuation">;</span>
            <span class="token comment">// Construct P2SH32 locking bytecode from redeem bytecode</span>
            <span class="token builtin">bytes</span> vaultLockingBytecode <span class="token operator">=</span> <span class="token number">0xaa20</span> <span class="token operator">+</span> <span class="token function">hash256</span><span class="token punctuation">(</span>theVault<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x87</span><span class="token punctuation">;</span>

            <span class="token comment">// Verify creation of Vault genesis outputs</span>

            <span class="token comment">// [1]</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> vaultLockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outpointTransactionHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span> <span class="token number">2100000000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">></span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// [2]</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> vaultLockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>       
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outpointTransactionHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span> <span class="token number">2100000000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">></span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// [3]</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> vaultLockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>       
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outpointTransactionHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span> <span class="token number">2100000000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">></span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// [4]</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> vaultLockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>       
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outpointTransactionHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span> <span class="token number">2100000000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">></span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// [5]</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> vaultLockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>       
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outpointTransactionHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span> <span class="token number">2100000000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">></span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// [6]</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> vaultLockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>       
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outpointTransactionHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span> <span class="token number">2100000000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">></span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// [7]</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> vaultLockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>       
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outpointTransactionHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span> <span class="token number">2100000000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">></span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Tag this FT mint for indexers </span>
            <span class="token comment">//</span>
            <span class="token comment">// 6a              OP_RETURN</span>
            <span class="token comment">// 04 46 42 43 48  &lt;'FBCH'></span>
            <span class="token comment">// 04 90 05 10 00  &lt;locktime></span>
            <span class="token builtin">bytes</span> announcement <span class="token operator">=</span> 
                <span class="token number">0x6a044642434804</span> <span class="token operator">+</span> 
                tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment<span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> announcement<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Ensure no other outputs can be created</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>           
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre> <h1 id="battery" data-svelte-h="svelte-10kj1o6">Battery</h1> <h2 id="battery-summary" data-svelte-h="svelte-11obcpj">Battery Summary</h2> <p data-svelte-h="svelte-qfyc9j">Constructs a series of properly initialized Gantry instances, which will all have the same categoryID inherited from the Battery.</p> <p data-svelte-h="svelte-ag9gyo">We found errors in the contract that would break it from performing the intended purpose.</p> <h2 id="battery-contract-analysis" data-svelte-h="svelte-1yqh41q">Battery Contract Analysis</h2> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>time <span class="token operator">>=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-qal6kb">There is no need for this, this will just make it so that the contract system can’t be deployed ahead of first Vault’s expiration.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-mqe8uk">There is no need for this if contract correctly verifies the outputs.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">        <span class="token comment">// Get the commitment </span>
        <span class="token builtin">bytes4</span> stepBytes <span class="token operator">=</span> <span class="token builtin">bytes4</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">int</span> step <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-1uvlhjq">No need to convert to <code>bytes4</code> if the Battery was instantiated properly.
It will already be 4 bytes, and we need to keep it as bytes because we will need it later when constructing the instance of Gantry.
Also, the <code>step</code> can be converted from <code>stepBytes</code> instead of using TX introspection again.
Suggested:</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">        <span class="token comment">// Get the commitment </span>
        <span class="token builtin">bytes</span> stepBytes <span class="token operator">=</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment<span class="token punctuation">;</span>
        <span class="token builtin">int</span> step <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>stepBytes<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-vbmr06">However, in the next lines:</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">        <span class="token comment">// Set the gantry commitment to a block on increment in the near future.</span>
        <span class="token builtin">bytes4</span> gantryStart <span class="token operator">=</span> <span class="token builtin">bytes4</span><span class="token punctuation">(</span>startTime <span class="token operator">-</span> <span class="token punctuation">(</span>startTime <span class="token operator">%</span> step<span class="token punctuation">)</span> <span class="token operator">+</span> step<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> gantryStart<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-27q9uq">we do need to convert to <code>bytes4</code> because here we are preparing a script num value to be written into a new output so have to enforce desired format.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">        <span class="token comment">// Get the redeem bytecode of the gantry instance</span>
        <span class="token builtin">bytes</span> gantryRedeemBytecode <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>vaultUnlockingBytecode<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">+</span> vaultUnlockingBytecode <span class="token operator">+</span>
                                     <span class="token number">0x04</span> <span class="token operator">+</span> stepBytes                                <span class="token operator">+</span>  <span class="token comment">// stepBytes</span>
                                     <span class="token number">0x20</span> <span class="token operator">+</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token operator">+</span>  <span class="token comment">// This tokenCategory</span>
                                     gantryUnlockingBytecode<span class="token punctuation">;</span>    </code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-1u42o5r">Assumption of 0x04 as push opcode for <code>stepBytes</code> is safe if Battery was initialized properly, since the covenant will guarantee it will stay 4 bytes further on.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">        <span class="token keyword">require</span><span class="token punctuation">(</span>
            <span class="token comment">// The second output is the gantry lockingBytecode</span>
            <span class="token number">0xaa20</span> <span class="token operator">+</span> <span class="token function">hash256</span><span class="token punctuation">(</span>gantryRedeemBytecode<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x87</span>
            <span class="token operator">==</span> tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode
        <span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-hqnhcn">Place a P2SH32 Vault on the 1st output.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">        <span class="token builtin">bytes</span> gantryCategory<span class="token punctuation">,</span> <span class="token builtin">bytes</span> gantryCapability <span class="token operator">=</span> tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Assure the gantry baton is a non-minting NFT</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>gantryCapability<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Assure the gantry category matches the battery category</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>gantryCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-soenqg">This would force the NFT to be immutable and break the Gantry because it needs mutable capability to function.
Fixed below, and suggested a simpler way to achieve it:</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">    <span class="token builtin">bytes</span> gantryCategory <span class="token operator">=</span>
        tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span>
        <span class="token number">0x01</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> gantryCategory<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-7v1af4">The below:</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">        <span class="token comment">// Prevent all the value from being cleared off</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">-</span> <span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">+</span> tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-1yl7ig">only makes sure that a max. of 1000 sats can be extracted as fee or another output.
It doesn’t prevent someone with hashrate from griefing the outputs by setting one of them to below dust value, or from giving most balance to the Gantry instead of back into Battery.
Also, since there’s no constraint on the number of outputs, NFTs of the category can escape the contract system.</p> <p data-svelte-h="svelte-1pibvi2">We should add:</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-1ndpddv">and rework the code that follows to:</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity">        <span class="token comment">// Enforce exact dust amount on the Gantry so that remainder must go</span>
        <span class="token comment">// back into Battery or pure BCH change at index 0.</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>step <span class="token operator">></span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Calculate and enforce next baton's step,</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">bytes4</span><span class="token punctuation">(</span>step <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// token category &amp; capability (pass on minting NFT),</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// and contract code.</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Burn the minting baton while allowing any remaining BCH</span>
            <span class="token comment">// to be extracted to output 0.</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre> <h2 id="battery-alternative-contract" data-svelte-h="svelte-iy9o8q">Battery Alternative Contract</h2> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">Battery</span><span class="token punctuation">(</span>

    <span class="token comment">// Correct contract initialization will have minting NFT's commitment</span>
    <span class="token comment">// set to bytes4(step), which will be the step set for 1st minted gantry,</span>
    <span class="token comment">// and will then get decremented for the next one until end step is reached.</span>

    <span class="token comment">// The end is the lowest step to create a Gantry for.</span>
    <span class="token builtin">int</span> endStep<span class="token punctuation">,</span>

    <span class="token comment">// Base time from which to calculate each Gantry's starting point, e.g.:</span>
    <span class="token comment">// --| baseTime</span>
    <span class="token comment">//   |------------------------------------| gantry 0 start</span>
    <span class="token comment">//   |------------| gantry 1 start</span>
    <span class="token comment">//   |----| gantry 2 start</span>
    <span class="token builtin">int</span> baseTime<span class="token punctuation">,</span>

    <span class="token comment">// Redeem bytecode tail of the gantry contracts</span>
    <span class="token builtin">bytes</span> gantryReedemBytecodeTail<span class="token punctuation">,</span>

    <span class="token comment">// Redeem bytecode tail of the vault contracts</span>
    <span class="token builtin">bytes</span> vaultReedemBytecodeTail<span class="token punctuation">,</span>

<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">function</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// Get the current step, we will mint a Gantry for this step</span>
        <span class="token builtin">bytes</span> stepBytes <span class="token operator">=</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment<span class="token punctuation">;</span>
        <span class="token builtin">int</span> step <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>stepBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Set the gantry's starting time at correct offset from baseTime</span>
        <span class="token builtin">bytes4</span> gantryStart <span class="token operator">=</span> <span class="token builtin">bytes4</span><span class="token punctuation">(</span>baseTime <span class="token operator">-</span> <span class="token punctuation">(</span>baseTime <span class="token operator">%</span> step<span class="token punctuation">)</span> <span class="token operator">+</span> step<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> gantryStart<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Construct the full redeem bytecode for the Gantry instance</span>
        <span class="token builtin">bytes</span> gantryRedeemBytecode <span class="token operator">=</span>
            <span class="token builtin">bytes</span><span class="token punctuation">(</span>vaultReedemBytecodeTail<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">+</span> vaultReedemBytecodeTail <span class="token operator">+</span>
            <span class="token number">0x04</span> <span class="token operator">+</span> stepBytes <span class="token operator">+</span>
            gantryReedemBytecodeTail<span class="token punctuation">;</span>

        <span class="token keyword">require</span><span class="token punctuation">(</span>
            <span class="token comment">// The second output must have the P2SH32 of the gantry redeem bytecode</span>
            <span class="token number">0xaa20</span> <span class="token operator">+</span> <span class="token function">hash256</span><span class="token punctuation">(</span>gantryRedeemBytecode<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x87</span>
            <span class="token operator">==</span> tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Ensure that Gantry inherits a mutable NFT so that it may update the</span>
        <span class="token comment">// commitment as it mints its Vaults.</span>
        <span class="token builtin">bytes</span> gantryCategory <span class="token operator">=</span>
            tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span>
            <span class="token number">0x01</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> gantryCategory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Exactly 2 outputs, so token state or BCH can't leak out.</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Enforce exact dust amount on the Gantry so that remainder must go</span>
        <span class="token comment">// back into Battery or pure BCH change at index 0.</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Fee allowance = 1000</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">></span>
            tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">-</span>
            <span class="token number">1800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>step <span class="token operator">></span> endStep<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Calculate and enforce next baton's step,</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token builtin">bytes4</span><span class="token punctuation">(</span>step <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// token category &amp; capability (pass on minting NFT),</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span>
                tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// and contract code.</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span>
                tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Burn the minting baton while allowing any remaining BCH</span>
            <span class="token comment">// to be extracted to output 0.</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Note: output 1 still mints a Gantry in this same TX,</span>
            <span class="token comment">// and it will be the last one to get minted.</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre> <h1 id="final-review" data-svelte-h="svelte-6l2co3">Final Review</h1> <p data-svelte-h="svelte-a72269">After the above review cycle, 2qx has implemented most suggestions and produced a new set of contracts, all of them found here:</p> <ul data-svelte-h="svelte-zofe4v"><li><p style="line-break:anywhere">https://github.com/2qx/future-bitcoin-cash/tree/3fab223e6472a24fda8b8c4cebc120a9293d7102/contracts</p></li></ul> <p data-svelte-h="svelte-1csg5xb">The contract system is expected to perform as intended.</p> <p data-svelte-h="svelte-117rupp"><a href="https://github.com/2qx/future-bitcoin-cash/blob/3fab223e6472a24fda8b8c4cebc120a9293d7102/contracts/vault.v2.cash" rel="nofollow"><strong>Vault</strong></a></p> <p data-svelte-h="svelte-1ecetb6">Contract has implemented most suggestions and is expected to perform as intended.</p> <p data-svelte-h="svelte-1vu1oto">The termination path has not been implemented, meaning it will be the lightest possible contract, and the trade-off is that each thread will leave a persistent UTXO in chain state.</p> <p data-svelte-h="svelte-1a14pu5"><a href="https://github.com/2qx/future-bitcoin-cash/blob/3fab223e6472a24fda8b8c4cebc120a9293d7102/contracts/coupon.v2.cash" rel="nofollow"><strong>Coupon</strong></a></p> <p data-svelte-h="svelte-1ecetb6">Contract has implemented most suggestions and is expected to perform as intended.</p> <p data-svelte-h="svelte-xxovqz">It targets just the bytecode (and not a particular category) so it can be used with any instance of a target Vault.</p> <p data-svelte-h="svelte-1jo10kt"><a href="https://github.com/2qx/future-bitcoin-cash/blob/3fab223e6472a24fda8b8c4cebc120a9293d7102/contracts/gantry.v2.cash" rel="nofollow"><strong>Gantry</strong></a></p> <p data-svelte-h="svelte-1ecetb6">Contract has implemented most suggestions and is expected to perform as intended.</p> <p data-svelte-h="svelte-1d37f90">It doesn’t implement time-skip, meaning the contract is simpler but it will have to be called in sequence even if some Vaults it spawns may never be used or have expired already.</p> <p data-svelte-h="svelte-1fvf4yb"><a href="https://github.com/2qx/future-bitcoin-cash/blob/3fab223e6472a24fda8b8c4cebc120a9293d7102/contracts/battery.v2.cash" rel="nofollow"><strong>Battery</strong></a></p> <p data-svelte-h="svelte-78c9tc">Contract has implemented suggested <a href="#battery-alternative-contract">alternative contract</a> verbatim and is expected to perform as intended.</p></main> <footer class="svelte-8o1gnw" data-svelte-h="svelte-d8bde3"><p><a href="/audit" class="svelte-8o1gnw">audit</a>
			■
			<a href="/code" class="svelte-8o1gnw">code of conduct</a>
			■

			<a href="/contracts" class="svelte-8o1gnw">contracts</a>
			■
			<a href="/flipstarter" class="svelte-8o1gnw">flipstarter</a>
			■
			<a target="_blank" href="https://github.com/2qx/future-bitcoin-cash" class="svelte-8o1gnw">source
				<img width="20px" src="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='-3%20-3%2030%2030'%3e%3cpath%20fill-rule='evenodd'%20clip-rule='evenodd'%20d='M12%202C6.47715%202%202%206.47715%202%2012C2%2017.5229%206.47715%2022%2012%2022C17.5229%2022%2022%2017.5229%2022%2012C22%206.47715%2017.5229%202%2012%202ZM0%2012C0%205.3726%205.3726%200%2012%200C18.6274%200%2024%205.3726%2024%2012C24%2018.6274%2018.6274%2024%2012%2024C5.3726%2024%200%2018.6274%200%2012Z'%20fill='rgba(0,0,0,0.7)'%20stroke='none'%20/%3e%3cpath%20fill-rule='evenodd'%20clip-rule='evenodd'%20d='M9.59162%2022.7357C9.49492%2022.6109%209.49492%2021.4986%209.59162%2019.399C8.55572%2019.4347%207.90122%2019.3628%207.62812%2019.1833C7.21852%2018.9139%206.80842%2018.0833%206.44457%2017.4979C6.08072%2016.9125%205.27312%2016.8199%204.94702%2016.6891C4.62091%2016.5582%204.53905%2016.0247%205.84562%2016.4282C7.15222%2016.8316%207.21592%2017.9303%207.62812%2018.1872C8.04032%2018.4441%209.02572%2018.3317%209.47242%2018.1259C9.91907%2017.9201%209.88622%2017.1538%209.96587%2016.8503C10.0666%2016.5669%209.71162%2016.5041%209.70382%2016.5018C9.26777%2016.5018%206.97697%2016.0036%206.34772%2013.7852C5.71852%2011.5669%206.52907%2010.117%206.96147%209.49369C7.24972%209.07814%207.22422%208.19254%206.88497%206.83679C8.11677%206.67939%209.06732%207.06709%209.73672%207.99999C9.73737%208.00534%2010.6143%207.47854%2012.0001%207.47854C13.386%207.47854%2013.8777%207.90764%2014.2571%207.99999C14.6365%208.09234%2014.94%206.36699%2017.2834%206.83679C16.7942%207.79839%2016.3844%208.99999%2016.6972%209.49369C17.0099%209.98739%2018.2372%2011.5573%2017.4833%2013.7852C16.9807%2015.2706%2015.9927%2016.1761%2014.5192%2016.5018C14.3502%2016.5557%2014.2658%2016.6427%2014.2658%2016.7627C14.2658%2016.9427%2014.4942%2016.9624%2014.8233%2017.8058C15.0426%2018.368%2015.0585%2019.9739%2014.8708%2022.6234C14.3953%2022.7445%2014.0254%2022.8257%2013.7611%2022.8673C13.2924%2022.9409%2012.7835%2022.9822%2012.2834%2022.9982C11.7834%2023.0141%2011.6098%2023.0123%2010.9185%2022.948C10.4577%2022.9051%2010.0154%2022.8343%209.59162%2022.7357Z'%20fill='rgba(0,0,0,0.7)'%20stroke='none'%20/%3e%3c/svg%3e" alt="GitHub"></a></p></footer> </div> </div>
	</body>
</html>
