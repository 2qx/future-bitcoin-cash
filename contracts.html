<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<!--link rel="icon" href="./favicon.png" /-->
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="manifest" href="manifest.json" />
		<style>
			@import url('https://fonts.googleapis.com/css2?family=Anybody:ital,wght@0,100..900;1,100..900&display=swap');
		</style>
		<script src="https://unpkg.com/@bitjson/qr-code@1.0.2/dist/qr-code.js"></script>
		
		<link href="./_app/immutable/assets/0.C48m0qV9.css" rel="stylesheet">
		<link href="./_app/immutable/assets/SvelteToast.BAXstrkn.css" rel="stylesheet"><title>Contracts</title><!-- HEAD_svelte-zpelw2_START --><!-- HEAD_svelte-zpelw2_END -->
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents">  <div class="app svelte-8o1gnw"><div class="warn svelte-wavrw1" data-svelte-h="svelte-wuhrry">Pre-alpha pre-release. Use at your own risk.<br>
	Bugs and usability issues may result in loss of funds.</div> <div class="wallet svelte-wavrw1"></div> <header class="svelte-wavrw1"><div class="corner svelte-wavrw1" data-svelte-h="svelte-9hijgq"><a href="/" class="svelte-wavrw1"><img src="/FBCH.svg" alt="Home" class="svelte-wavrw1"></a></div> <nav class="svelte-wavrw1"><svg viewBox="0 0 2 3" aria-hidden="true" class="svelte-wavrw1"><path d="M0,0 L1,2 C1.5,3 1.5,3 2,3 L2,0 Z" class="svelte-wavrw1"></path></svg> <ul class="svelte-wavrw1"><li style="font-weight: 900;" class="svelte-wavrw1"><a style="font-size: larger" href="/" class="svelte-wavrw1" data-svelte-h="svelte-xqmuyf"><b>ⓘ</b></a></li> <li class="svelte-wavrw1"><a href="/vaults" class="svelte-wavrw1" data-svelte-h="svelte-18ikwbv">Vaults</a></li> <li class="svelte-wavrw1"><a href="/write" class="svelte-wavrw1" data-svelte-h="svelte-1rwkpbp">Write</a></li></ul> <svg viewBox="0 0 2 3" aria-hidden="true" class="svelte-wavrw1"><path d="M0,0 L0,3 C0.5,3 0.5,3 1,2 L2,0 Z" class="svelte-wavrw1"></path></svg></nav> <div class="status svelte-wavrw1"></div> </header> <ul class="_toastContainer svelte-yh90az"> </ul> <main class="svelte-8o1gnw"><nav class="toc" data-svelte-h="svelte-9f2uen"><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#vault">Vault</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#coupon">Coupon</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#gantry">Gantry</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#battery">Battery</a></li></ol></nav>  <h1 id="vault" data-svelte-h="svelte-1ndpua0">Vault</h1> <p data-svelte-h="svelte-3k23hk">The vault allows swapping coins for fungible tokens on a 1:1 basis until a certain block height is reached. When the <code>locktime</code> has been met, the vault allows bi-directional swapping.</p> <p data-svelte-h="svelte-1q9znac">Although the vault may lock coins against any fungible token, only contractually issued tokens with the full auditable supply sent to the vault should be treated as locked futures on the open market.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">pragma</span> cashscript <span class="token operator">^</span><span class="token version number">0.10.0</span><span class="token punctuation">;</span>

<span class="token comment">// Vault - Store coins locked for tokens until maturation date. </span>
<span class="token comment">//</span>
<span class="token comment">// 2024-06-05</span>
<span class="token comment">//</span>
<span class="token comment">// From: Future Bitcoin Cash</span>
<span class="token comment">//</span>
<span class="token comment">// Author: 2qx &lt;2qx_in_the_future@small.neomailbox.ch></span>
<span class="token comment">//</span>
<span class="token comment">//     If redeeming tokens for coins in the vault: </span>
<span class="token comment">// [ ]   enforce the timelock is met.</span>
<span class="token comment">//</span>
<span class="token comment">// [ ] Assure the utxo token category matches that of the output.</span>
<span class="token comment">// [ ] Assure the the utxo and output lock match per in the transaction.</span>
<span class="token comment">// [ ] Assure an equal amounts of coins are exchanged for tokens</span>
<span class="token comment">//</span>
<span class="token comment">//</span>
<span class="token comment">//  inputs              outputs</span>
<span class="token comment">//  [0] contract    ->  [0] contract</span>
<span class="token comment">//  [1] userPkh     =>  [1] userPkh</span>
<span class="token comment">//  [2] coupon?     -^</span>
<span class="token comment">//</span>

<span class="token keyword">contract</span> <span class="token class-name">Vault</span><span class="token punctuation">(</span><span class="token builtin">int</span> locktime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">function</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        
        <span class="token comment">// If tokens are flowing back into this contract</span>
        <span class="token comment">// OP_INPUTINDEX OP_OUTPUTTOKENAMOUNT OP_INPUTINDEX OP_UTXOTOKENAMOUNT OP_GREATERTHAN OP_IF </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">></span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        

            <span class="token comment">// Enforce a BIP65 timelock </span>
            <span class="token comment">// Note, intended for use with block height based locks </span>
            <span class="token comment">// (where:  locktime &lt; 500M).</span>
            <span class="token comment">// OP_0 OP_PICK OP_CHECKLOCKTIMEVERIFY OP_DROP</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>time <span class="token operator">>=</span> locktime<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token punctuation">&#125;</span> <span class="token comment">// OP_ENDIF </span>
         
        <span class="token comment">// </span>
        <span class="token comment">// Inspired by wrapped.cash c. Nov 2023</span>
        <span class="token comment">// Author: Dagur Valberg Johannsson &lt;dagurval@pvv.ntnu.no> </span>
        <span class="token comment">// License: MIT</span>
        <span class="token comment">//</span>
        <span class="token comment">// ensure the token in and out matches</span>
        <span class="token comment">// OP_INPUTINDEX OP_UTXOTOKENCATEGORY OP_INPUTINDEX OP_OUTPUTTOKENCATEGORY OP_EQUAL OP_VERIFY </span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>
          tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory 
          <span class="token operator">==</span> 
          tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory
          <span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// Enforce that this contract lives on</span>
        <span class="token comment">// OP_INPUTINDEX OP_OUTPUTBYTECODE OP_INPUTINDEX OP_UTXOBYTECODE OP_EQUAL OP_VERIFY</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>
          tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode 
          <span class="token operator">==</span> 
          tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode
          <span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// ensure the sum of sats and tokens in </span>
        <span class="token comment">// matches the sum of sats and tokens out.</span>
        <span class="token comment">// OP_INPUTINDEX OP_UTXOTOKENAMOUNT OP_INPUTINDEX OP_UTXOVALUE OP_ADD</span>
        <span class="token comment">// OP_INPUTINDEX OP_OUTPUTTOKENAMOUNT OP_INPUTINDEX OP_OUTPUTVALUE OP_ADD </span>
        <span class="token comment">// OP_NUMEQUAL</span>
        <span class="token comment">// OP_NIP        </span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>
          tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">+</span> 
          tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>value 
          <span class="token operator">==</span> 
          tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">+</span> 
          tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>value
         <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre> <h1 id="coupon" data-svelte-h="svelte-1grnp6w">Coupon</h1> <p data-svelte-h="svelte-y3xa8e">A coupon holds some unspent output that can be applied when a certain amount of satoshis are being placed in a vault. The contract limits use of a coupon utxo to one per transaction.</p> <p data-svelte-h="svelte-1xzb9ty">Every vault has known correlate coupon addresses, that can be determined given the vault locking bytecode.</p> <p data-svelte-h="svelte-g6us73">If (in the future) whole coins become more unattainable, it’s also possible to create coupon covenants for 10M and 1M sat placements, without modifying the logic of the coupon contract, just by changing the <code>amount</code> parameter.</p> <p data-svelte-h="svelte-1ozf3od">The coupon contract holds any normal UTXO sent to it as a applicable to a vault placement transaction. So a coupon of 1M sats is created by sending 1M sats to the coupon contract. A hundred coupons could be written by sending one hundred outputs with 1M sats each to the coupon contract. <em>Coupons</em> are just normal UTXOs that can be funded from any software that can a send output Bitcoin Cash to the contract address. The value of each coupon is simply the value of the each output.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">pragma</span> cashscript <span class="token operator">^</span><span class="token version number">0.10.0</span><span class="token punctuation">;</span>

<span class="token comment">// Coupon - apply* utxo coupons by spending at least &lt;amount> on &lt;lock></span>
<span class="token comment">//</span>
<span class="token comment">// 2024-06-05</span>
<span class="token comment">//</span>
<span class="token comment">// From: Future Bitcoin Cash</span>
<span class="token comment">//</span>
<span class="token comment">// Author: 2qx &lt;2qx_in_the_future@small.neomailbox.ch></span>
<span class="token comment">//</span>
<span class="token comment">// Allow anyone to use an unspent output (utxo) in a transaction ...</span>
<span class="token comment">//</span>
<span class="token comment">// ... given:</span>
<span class="token comment">//</span>
<span class="token comment">// [ ] the zeroth inflow value exceeds a predefined amount </span>
<span class="token comment">// [ ] the zeroth input is to a predefined address</span>
<span class="token comment">// [ ] the coupon must be applied as the last input</span>
<span class="token comment">//</span>
<span class="token comment">// * Limit one per transaction.</span>
<span class="token comment">//</span>
<span class="token comment">// Note: This contract is designed to run as part of an integrated</span>
<span class="token comment">// multi-contract system. It's not in itself sufficient to assure </span>
<span class="token comment">// an advisory doesn't claim all coupons instantly for no cost.</span>
<span class="token comment">//</span>
<span class="token comment">// Also note: This instance is designed where the &#96;lock&#96;, or destination, </span>
<span class="token comment">// is the first input and output. If the lock isn't spendable, or not the first</span>
<span class="token comment">// input, coupons will not be redeemable.</span>
<span class="token comment">//</span>
<span class="token comment">// ... If there is no time or monetary cost to spend every coupon, </span>
<span class="token comment">// it should be expected that they will all be cleaned at once.</span>
<span class="token comment">//</span>

<span class="token keyword">contract</span> <span class="token class-name">Coupon</span><span class="token punctuation">(</span>
  <span class="token comment">// Minimum spent (sats) to claim each coupon utxo.</span>
  <span class="token builtin">int</span> amount<span class="token punctuation">,</span>
  
  <span class="token comment">// Contract holding the logic.</span>
  <span class="token builtin">bytes</span> lock
<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

  <span class="token keyword">function</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
    <span class="token comment">// assure at the minium amount is sent to the intended contract</span>
    <span class="token comment">// OP_0 OP_OUTPUTVALUE OP_0 OP_UTXOVALUE OP_SUB OP_1 OP_ROLL OP_GREATERTHANOREQUAL OP_VERIFY</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">-</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">>=</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// Check that the Coupon is interacting with an existing Vault instance </span>
    <span class="token comment">// OP_0 OP_UTXOBYTECODE OP_1 OP_ROLL OP_EQUAL OP_VERIFY</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// The coupon must be spent as the last input, </span>
    <span class="token comment">//   therefore only coupon may be spent at a time.</span>
    <span class="token comment">// OP_INPUTINDEX OP_1 OP_ADD OP_TXINPUTCOUNT OP_NUMEQUAL</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre> <h1 id="gantry" data-svelte-h="svelte-1px4dhc">Gantry</h1> <p data-svelte-h="svelte-1oz9at7">The gantry contract sends a fixed number of tokens into utxo “threads” on each vault contract for a given blocktime.</p> <p data-svelte-h="svelte-1v38al8">The gantry automates issuing fungible tokens into the vault.</p> <p data-svelte-h="svelte-eav5o4">Gantries issue vaults at different time intervals.</p> <table data-svelte-h="svelte-wtt2eu"><thead><tr><th align="right">Block Interval</th> <th align="center">10^x</th> <th align="right">Spacing</th></tr></thead> <tbody><tr><td align="right">1,000 blocks</td> <td align="center">3</td> <td align="right">~1 week</td></tr> <tr><td align="right">10,000 blocks</td> <td align="center">4</td> <td align="right">~2.5 months</td></tr> <tr><td align="right">100,000 blocks</td> <td align="center">5</td> <td align="right">~23 months</td></tr> <tr><td align="right">1,000,000 blocks</td> <td align="center">6</td> <td align="right">~19 years</td></tr></tbody></table> <p data-svelte-h="svelte-eb4trz">So while one gantry issues vaults every week, another gantry will issue vaults every 2.5 months. In this way, it’s possible to obtain tokens for any approximate date in the future, from any of forty vaults in use at one time.</p> <p data-svelte-h="svelte-1frtzbk">Anyone may that can construct a transaction to satisfy the requirement of the gantry <code>execute</code> function may step the gantry forward and commission tokens into a new vault.</p> <p data-svelte-h="svelte-arjt1u">The below version has seven (7) threads, each thread has enough tokens to satisfy locking the entire coin supply.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">pragma</span> cashscript <span class="token operator">^</span><span class="token version number">0.10.0</span><span class="token punctuation">;</span>

<span class="token comment">// Gantry - Create vault contracts with fungible tokens in a uniform way. </span>
<span class="token comment">//</span>
<span class="token comment">// 2024-08-08 </span>
<span class="token comment">//</span>
<span class="token comment">// From: Future Bitcoin Cash</span>
<span class="token comment">//</span>
<span class="token comment">// Author: 2qx &lt;2qx_in_the_future@small.neomailbox.ch></span>
<span class="token comment">//</span>
<span class="token comment">// NFT commentment stores the next series locktime in 32-bit LE</span>
<span class="token comment">//</span>
<span class="token comment">// [ ] Require the minting baton in the input</span>
<span class="token comment">// [ ] Get the current step increment for the chain of futures</span>
<span class="token comment">// [ ] Get the current vault locktime to be printed.</span>
<span class="token comment">//</span>
<span class="token comment">//   either</span>
<span class="token comment">// [ ] Mint an array of FT utxos, </span>
<span class="token comment">// [ ] send them off to a Vault</span>
<span class="token comment">//</span>
<span class="token comment">//   or</span>
<span class="token comment">// [ ] skip every 10th print.</span>
<span class="token comment">//</span>
<span class="token comment">// [ ] increment locktime height value stored on NFT baton</span>
<span class="token comment">// [ ] assure NFT baton is returned</span>
<span class="token comment">//</span>
<span class="token comment">//</span>
<span class="token comment">//  Gantry i/o Flow:</span>
<span class="token comment">//</span>
<span class="token comment">//  Inputs              Outputs</span>
<span class="token comment">//  [0] NFT mintBaton   ->  [0] NFT mintBaton</span>
<span class="token comment">//                      =>  [1] FTs Vault</span>
<span class="token comment">//                      =>  [2] FTs Vault</span>
<span class="token comment">//                      =>  [3] FTs Vault</span>
<span class="token comment">//                      =>  [4] FTs Vault</span>
<span class="token comment">//                      =>  [5] FTs Vault</span>
<span class="token comment">//                      =>  [6] FTs Vault</span>
<span class="token comment">//                      =>  [7] FTs Vault</span>
<span class="token comment">//                          [8] OP_RETURN FBCH &lt;locktime></span>
<span class="token comment">//  </span>
<span class="token comment">//  ... but skip every 10th token print, </span>
<span class="token comment">//   which will be printed by the gantry of the next order.</span>
<span class="token comment">//  [0] NFT mintBaton   =>  [0] NFT mintBaton</span>
<span class="token comment">//</span>
<span class="token comment">// NOTE: The production version differs from the final audit:</span>
<span class="token comment">// - Sats to fund the Gantry transactions are secured in the baton UTXO (line 68),</span>
<span class="token comment">// - Some minor optimizations were made to stay under the 201 op_code limit:</span>
<span class="token comment">//   - used tokenAmount as number instead of stack variable [92,98,104...]</span>
<span class="token comment">//   - inlined op_return tag in single line require (line 137)</span>
<span class="token comment">//</span>


<span class="token keyword">contract</span> <span class="token class-name">Gantry</span><span class="token punctuation">(</span>
    <span class="token builtin">int</span> step<span class="token punctuation">,</span> 
    <span class="token builtin">bytes</span> vaultUnlockingBytecode
    <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">function</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// Gantry covenant and the associated NFT baton must be spent as index 0</span>
        <span class="token comment">// input and passed on to index 0 output, funded with some dust BCH in order</span>
        <span class="token comment">// to avoid griefing by someone with access to hashrate</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> 
        tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span>
            tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">-</span> <span class="token number">8500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token builtin">int</span> locktime <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Locktime stored in mutable NFT commitment MUST be incremented by &lt;step></span>
        <span class="token comment">// and stored as bytes4 LE uint again.</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span>
            <span class="token builtin">bytes4</span><span class="token punctuation">(</span>locktime <span class="token operator">+</span> step<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Every 10th step, skip creating Vault and just increment the commitment</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>locktime <span class="token operator">/</span> step<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Construct redeem bytecode for the Vault instance being created</span>
            <span class="token builtin">bytes</span> theVault <span class="token operator">=</span> 
                <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>locktime<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>locktime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token comment">// int locktime</span>
                vaultUnlockingBytecode<span class="token punctuation">;</span>
            <span class="token comment">// Construct P2SH32 locking bytecode from redeem bytecode</span>
            <span class="token builtin">bytes</span> vaultLockingBytecode <span class="token operator">=</span> <span class="token number">0xaa20</span> <span class="token operator">+</span> <span class="token function">hash256</span><span class="token punctuation">(</span>theVault<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x87</span><span class="token punctuation">;</span>

            <span class="token comment">// Verify creation of Vault genesis outputs</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> vaultLockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outpointTransactionHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span> <span class="token number">2100000000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> vaultLockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>       
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outpointTransactionHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span> <span class="token number">2100000000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> vaultLockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>       
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outpointTransactionHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span> <span class="token number">2100000000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> vaultLockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>       
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outpointTransactionHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span> <span class="token number">2100000000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> vaultLockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>       
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outpointTransactionHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span> <span class="token number">2100000000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> vaultLockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>       
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outpointTransactionHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span> <span class="token number">2100000000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> vaultLockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>       
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outpointTransactionHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenAmount <span class="token operator">==</span> <span class="token number">2100000000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token comment">// Tag FT metadata for indexers </span>
            <span class="token comment">//</span>
            <span class="token comment">// 6a              OP_RETURN</span>
            <span class="token comment">// 04 46 42 43 48  FBCH</span>
            <span class="token comment">// 03 90 05 10     &lt;locktime></span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span> <span class="token number">0x6a0446424348</span> <span class="token operator">+</span>
                                  <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>locktime<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">+</span>  <span class="token builtin">bytes</span><span class="token punctuation">(</span>locktime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Ensure no other outputs can be created</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

        <span class="token punctuation">&#125;</span>     
        
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre> <h1 id="battery" data-svelte-h="svelte-10kj1o6">Battery</h1> <p data-svelte-h="svelte-11g838d">The battery deployed a fixed number of gantries, similar to the way gantries deploy vaults. It then burned the minting baton used to create the gantries minting batons.</p> <pre class="language-solidity"><!-- HTML_TAG_START --><code class="language-solidity"><span class="token keyword">pragma</span> cashscript <span class="token operator">^</span><span class="token version number">0.10.0</span><span class="token punctuation">;</span>

<span class="token comment">// Battery - Spawn an array of vault deploying gantries from a single utxo.</span>
<span class="token comment">//</span>
<span class="token comment">// 2024-08-08</span>
<span class="token comment">// </span>
<span class="token comment">// Executed in block #858,444 on Aug 10, 2024</span>
<span class="token comment">// 02eb65ab5ce602b3025bc0c139cd22709983ae1acb58f476b86d6e31dd585e55</span>
<span class="token comment">// bitcoincash:pd3hc4smdeu4kpwyvjq645d0ts5n9wxgvp3x7gg3my65u2kkw766xxxl8wdgp</span>
<span class="token comment">//</span>
<span class="token comment">// From: Future Bitcoin Cash</span>
<span class="token comment">//</span>
<span class="token comment">// Author: 2qx &lt;2qx_in_the_future@small.neomailbox.ch></span>
<span class="token comment">//</span>
<span class="token comment">// A Battery releases a series of Gantries at small powers of 10 that </span>
<span class="token comment">// go on to create Futures Vaults on those respective intervals.</span>
<span class="token comment">//</span>
<span class="token comment">// Given a minting NFT with the commitment containing a power of 10, </span>
<span class="token comment">// mint a sequence of NFTs with minting capability</span>
<span class="token comment">// sending mutable batons NFTs to the corresponding Gantry.</span>
<span class="token comment">//</span>
<span class="token comment">//  execute():</span>
<span class="token comment">//</span>
<span class="token comment">//  inputs                           outputs</span>
<span class="token comment">//  [0] Battery + NFT 0x40420F00 10ᴇ6 ->  [0] Gantry10ᴇ6 + NFT* &lt;startTime></span>
<span class="token comment">//                                    =>  [1] Battery    + NFT  0xA0860100</span>
<span class="token comment">//</span>
<span class="token comment">//  [0] Battery + NFT 0xA0860100 10ᴇ5 ->  [0] Gantry10ᴇ5 + NFT* &lt;startTime></span>
<span class="token comment">//                                    =>  [1] Battery    + NFT  0x10270000</span>
<span class="token comment">//</span>
<span class="token comment">//  ... 0x10270000 10ᴇ4 ... 0xE8030000 10ᴇ3 ... 0x64000000 10ᴇ2</span>
<span class="token comment">//</span>
<span class="token comment">//  [0] Battery + NFT 0x&lt;end>        ->  [0]  Gantry10ᴇ2 + NFT* &lt;startTime></span>
<span class="token comment">//                                       [1]  Burn NFT, sats are unencumbered.</span>
<span class="token comment">//                                       </span>
<span class="token comment">//  NOTE:</span>
<span class="token comment">//  This final production version: </span>
<span class="token comment">//    - Swaps the order of outputs so Gantries are first.</span>
<span class="token comment">//       (this allows the mutable gantry NFT later mint FTs)</span>
<span class="token comment">//    - Accomodates variable length baton values, line 80</span>
<span class="token comment">//    - Funds the gantry with sats per lines 100, 104</span>
<span class="token comment">// </span>

<span class="token keyword">contract</span> <span class="token class-name">Battery</span><span class="token punctuation">(</span>

    <span class="token comment">// Correct contract initialization will have minting NFT's commitment</span>
    <span class="token comment">// set to &lt;step> from the NFT commitment, which will be the step set for 1st minted gantry,</span>
    <span class="token comment">// and will then get decremented for the next one until end step is reached.</span>

    <span class="token comment">// The end is the smallest power of 10 to create a Gantry for.</span>
    <span class="token builtin">int</span> endStep<span class="token punctuation">,</span>

    <span class="token comment">// Base time from which to calculate each Gantry's starting point, e.g.:</span>
    <span class="token comment">// --| baseTime</span>
    <span class="token comment">//   |------------------------------------| gantry 0 start</span>
    <span class="token comment">//   |------------| gantry 1 start</span>
    <span class="token comment">//   |----| gantry 2 start</span>
    <span class="token builtin">int</span> baseTime<span class="token punctuation">,</span>

    <span class="token comment">// Redeem bytecode tail of the gantry contracts</span>
    <span class="token builtin">bytes</span> gantryReedemBytecodeTail<span class="token punctuation">,</span>

    <span class="token comment">// Redeem bytecode tail of the vault contracts</span>
    <span class="token builtin">bytes</span> vaultReedemBytecodeTail<span class="token punctuation">,</span>

<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">function</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// Get the current step, we will mint a Gantry for this step</span>
        <span class="token builtin">bytes</span> stepBytes <span class="token operator">=</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment<span class="token punctuation">;</span>
        <span class="token builtin">int</span> step <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>stepBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Set the gantry's starting time at correct offset from baseTime</span>
        <span class="token builtin">bytes4</span> gantryStart <span class="token operator">=</span> <span class="token builtin">bytes4</span><span class="token punctuation">(</span>baseTime <span class="token operator">-</span> <span class="token punctuation">(</span>baseTime <span class="token operator">%</span> step<span class="token punctuation">)</span> <span class="token operator">+</span> step<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> gantryStart<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Construct the full redeem bytecode for the Gantry instance</span>
        <span class="token builtin">bytes</span> gantryRedeemBytecode <span class="token operator">=</span>
            <span class="token builtin">bytes</span><span class="token punctuation">(</span>vaultReedemBytecodeTail<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">+</span> vaultReedemBytecodeTail <span class="token operator">+</span>
            <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>             <span class="token operator">+</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span>   <span class="token operator">+</span> 
            gantryReedemBytecodeTail<span class="token punctuation">;</span>

        <span class="token keyword">require</span><span class="token punctuation">(</span>
            <span class="token comment">// The first output must have the P2SH32 of the gantry redeem bytecode</span>
            <span class="token number">0xaa20</span> <span class="token operator">+</span> <span class="token function">hash256</span><span class="token punctuation">(</span>gantryRedeemBytecode<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x87</span>
            <span class="token operator">==</span> tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Ensure that Gantry inherits a mutable NFT so that it may update the</span>
        <span class="token comment">// commitment as it mints its Vaults.</span>
        <span class="token builtin">bytes</span> gantryCategory <span class="token operator">=</span>
            tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span>
            <span class="token number">0x01</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> gantryCategory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Exactly 2 outputs, so token state or BCH can't leak out.</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Fund each gantry in a single utxo for about 100 years.</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">></span> <span class="token number">42500000000</span><span class="token operator">/</span>step<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Fee allowance = 1000</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">></span>
            tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">-</span> <span class="token number">42500000000</span><span class="token operator">/</span>step <span class="token operator">-</span>
            <span class="token number">1800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>step <span class="token operator">></span> endStep<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Calculate and enforce next baton's step,</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nftCommitment <span class="token operator">==</span> <span class="token builtin">bytes4</span><span class="token punctuation">(</span>step <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// token category &amp; capability (pass on minting NFT),</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span>
                tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// and contract code.</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode <span class="token operator">==</span>
                tx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeInputIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lockingBytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Burn the minting baton while allowing any remaining BCH</span>
            <span class="token comment">// to be extracted to output 1.</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenCategory <span class="token operator">==</span> <span class="token number">0</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Note: output 1 still mints a Gantry in this same TX,</span>
            <span class="token comment">// and it will be the last one to get minted.</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre></main> <footer class="svelte-8o1gnw" data-svelte-h="svelte-d8bde3"><p><a href="/audit" class="svelte-8o1gnw">audit</a>
			■
			<a href="/code" class="svelte-8o1gnw">code of conduct</a>
			■

			<a href="/contracts" class="svelte-8o1gnw">contracts</a>
			■
			<a href="/flipstarter" class="svelte-8o1gnw">flipstarter</a>
			■
			<a target="_blank" href="https://github.com/2qx/future-bitcoin-cash" class="svelte-8o1gnw">source
				<img width="20px" src="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='-3%20-3%2030%2030'%3e%3cpath%20fill-rule='evenodd'%20clip-rule='evenodd'%20d='M12%202C6.47715%202%202%206.47715%202%2012C2%2017.5229%206.47715%2022%2012%2022C17.5229%2022%2022%2017.5229%2022%2012C22%206.47715%2017.5229%202%2012%202ZM0%2012C0%205.3726%205.3726%200%2012%200C18.6274%200%2024%205.3726%2024%2012C24%2018.6274%2018.6274%2024%2012%2024C5.3726%2024%200%2018.6274%200%2012Z'%20fill='rgba(0,0,0,0.7)'%20stroke='none'%20/%3e%3cpath%20fill-rule='evenodd'%20clip-rule='evenodd'%20d='M9.59162%2022.7357C9.49492%2022.6109%209.49492%2021.4986%209.59162%2019.399C8.55572%2019.4347%207.90122%2019.3628%207.62812%2019.1833C7.21852%2018.9139%206.80842%2018.0833%206.44457%2017.4979C6.08072%2016.9125%205.27312%2016.8199%204.94702%2016.6891C4.62091%2016.5582%204.53905%2016.0247%205.84562%2016.4282C7.15222%2016.8316%207.21592%2017.9303%207.62812%2018.1872C8.04032%2018.4441%209.02572%2018.3317%209.47242%2018.1259C9.91907%2017.9201%209.88622%2017.1538%209.96587%2016.8503C10.0666%2016.5669%209.71162%2016.5041%209.70382%2016.5018C9.26777%2016.5018%206.97697%2016.0036%206.34772%2013.7852C5.71852%2011.5669%206.52907%2010.117%206.96147%209.49369C7.24972%209.07814%207.22422%208.19254%206.88497%206.83679C8.11677%206.67939%209.06732%207.06709%209.73672%207.99999C9.73737%208.00534%2010.6143%207.47854%2012.0001%207.47854C13.386%207.47854%2013.8777%207.90764%2014.2571%207.99999C14.6365%208.09234%2014.94%206.36699%2017.2834%206.83679C16.7942%207.79839%2016.3844%208.99999%2016.6972%209.49369C17.0099%209.98739%2018.2372%2011.5573%2017.4833%2013.7852C16.9807%2015.2706%2015.9927%2016.1761%2014.5192%2016.5018C14.3502%2016.5557%2014.2658%2016.6427%2014.2658%2016.7627C14.2658%2016.9427%2014.4942%2016.9624%2014.8233%2017.8058C15.0426%2018.368%2015.0585%2019.9739%2014.8708%2022.6234C14.3953%2022.7445%2014.0254%2022.8257%2013.7611%2022.8673C13.2924%2022.9409%2012.7835%2022.9822%2012.2834%2022.9982C11.7834%2023.0141%2011.6098%2023.0123%2010.9185%2022.948C10.4577%2022.9051%2010.0154%2022.8343%209.59162%2022.7357Z'%20fill='rgba(0,0,0,0.7)'%20stroke='none'%20/%3e%3c/svg%3e" alt="GitHub"></a></p></footer> </div> </div>
	</body>
</html>
